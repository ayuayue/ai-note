<style>
  /* CSS Variables for fragment */
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --bg-color: #f8f9fa;
    --text-color: #34495e;
    --border-color: #e9ecef;
    --card-bg: #ffffff;
  }

  /* TOC Sidebar Styles */
  .article-layout {
    display: flex;
    max-width: 1400px;
    margin: 0 auto;
    gap: 30px;
    padding: 0 20px;
  }

  .main-content {
    flex: 1;
    min-width: 0;
  }

  .toc-sidebar {
    width: 280px;
    flex-shrink: 0;
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .toc-header h3 {
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 10px;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 8px;
  }

  .toc-link {
    display: block;
    padding: 6px 10px;
    color: var(--text-color);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }

  .toc-link:hover {
    background: var(--secondary-color);
    color: white;
    padding-left: 15px;
  }

  .toc-link.active {
    background: var(--secondary-color);
    color: white;
    font-weight: 500;
  }

  .toc-sublist {
    list-style: none;
    padding-left: 20px;
    margin-top: 5px;
  }

  .toc-sublist .toc-link {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  /* Post Styles */
  .post {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
  }

  .post-header {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
  }

  .post-title {
    color: var(--primary-color);
    font-size: 2rem;
    margin-bottom: 15px;
  }

  .post-meta {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 0.95rem;
    color: #6c757d;
  }

  .post-date {
    background-color: #e3f2fd;
    color: var(--secondary-color);
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 500;
  }

  .post-category {
    background-color: #e8f5e9;
    color: #4caf50;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 500;
  }

  .warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 30px;
    text-align: center;
    font-size: 0.9rem;
  }

  .post-content {
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--text-color);
  }

  .post-content h1,
  .post-content h2,
  .post-content h3,
  .post-content h4,
  .post-content h5,
  .post-content h6 {
    color: var(--primary-color);
    margin-top: 35px;
    margin-bottom: 20px;
    scroll-margin-top: 20px;
  }

  .post-content h2 {
    font-size: 1.5rem;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }

  .post-content h3 {
    font-size: 1.3rem;
    color: #2980b9;
  }

  .post-content p {
    margin-bottom: 18px;
  }

  .post-content code {
    background-color: #e8eaed;
    padding: 3px 7px;
    border-radius: 4px;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier,
      monospace;
    color: #c0392b;
    font-size: 0.9em;
  }

  .post-content pre {
    background-color: #2d2d2d;
    color: #f8f8f2;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 25px 0;
    font-size: 0.9em;
    line-height: 1.5;
    position: relative;
  }

  .post-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  .copy-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #3498db;
    border: 1px solid #2980b9;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 10;
  }

  .copy-button:hover {
    background: #2980b9;
    border-color: #2471a3;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .copy-button.copied {
    background: #4caf50;
    border-color: #4caf50;
  }

  /* Mermaid diagram styles */
  .mermaid {
    background-color: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    text-align: center;
  }

  /* TABLE STYLES */
  .post-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border-radius: 8px;
  }

  .post-content table th,
  .post-content table td {
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    text-align: left;
  }

  /* 确保表格头部样式正确 */
  .post-content table thead {
    background-color: var(--secondary-color);
    color: white;
  }

  /* 覆盖pandoc生成的.header类样式 */
  .post-content table tr.header {
    background-color: var(--secondary-color) !important;
    color: white !important;
  }

  .post-content table tr.header th {
    color: white !important;
  }

  .post-content table tbody tr:nth-of-type(even) {
    background-color: rgba(233, 236, 239, 0.5);
  }

  .post-content table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.1);
  }

  /* 响应式表格 */
  @media (max-width: 768px) {
    .post-content table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .article-layout {
      flex-direction: column;
    }

    .toc-sidebar {
      width: 100%;
      position: static;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .post {
      padding: 20px;
    }

    .post-title {
      font-size: 1.6rem;
    }

    .post-content {
      font-size: 1rem;
    }

    .article-layout {
      padding: 0 15px;
    }
  }
</style>

<!-- 引入本地 Mermaid 库 -->
<script src="../../js/mermaid.min.js"></script>
<script>
  // 关键修复：初始化时立即禁止自动渲染
  if (typeof mermaid !== "undefined") {
    mermaid.initialize({
      startOnLoad: false,
      theme: "default",
      securityLevel: "loose",
    });
  }
</script>

<div class="article-layout">
  <div class="main-content">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">JVM类加载器与热加载技术深度剖析：从原理到实践</h1>
        <div class="post-meta">
          <div class="post-date">2026/1/30</div>
          <div class="post-category">2026-01</div>
        </div>
      </header>
      <div class="warning">
        ⚠️ 注意：此内容由 AI 协助生成，准确性未经验证，请谨慎使用
      </div>
      <div class="post-content" id="post-content"><h2 id="开头摘要">开头摘要</h2>
<p>本文深入剖析JVM类加载器机制与类唯一限定名的作用，解释为何默认类加载器无法实现热加载，并提供自定义类加载器实现热加载的完整方案。适合需要理解JVM底层机制、实现动态更新功能的Java中级和高级开发者，内容涵盖从基础概念到框架集成的全链路知识。</p>
<h2 id="目录">目录</h2>
<ul>
<li>#类加载器基础概念</li>
<li>#类唯一限定名与命名空间</li>
<li>#双亲委派机制深度解析</li>
<li>#自定义类加载器实现</li>
<li>#热加载原理与实现</li>
<li>#实战案例spring框架中的热部署</li>
<li>#总结</li>
<li>#延伸阅读</li>
<li>#一句话记忆</li>
</ul>
<h2 id="类加载器基础概念">类加载器基础概念</h2>
<h3 id="概念解释">概念解释</h3>
<p>类加载器是JVM的组成部分，负责将Class文件加载到JVM内存中，这一过程分为<strong>加载</strong>、<strong>链接</strong>和<strong>初始化</strong>三个阶段。加载阶段通过类的全限定名获取二进制字节流，将字节流转化为方法区的运行时数据结构，并在堆中生成对应的Class对象。链接阶段包括验证、准备和解析过程，确保类信息的正确性和可用性。初始化阶段则是执行类构造器<code>&lt;clinit&gt;</code>方法，对静态变量和静态代码块进行初始化。</p>
<p>Java中的类加载分为<strong>隐式加载</strong>和<strong>显示加载</strong>两种方式。隐式加载是程序在运行过程中当碰到通过new等方式生成对象时，隐式调用类装载器加载对应的类到JVM中。显示加载则是通过Class.forName()、getClassLoader().loadClass()等方法显式加载需要的类。这种动态加载机制使得JVM无需一次性加载所有类，而是按需加载，节省了内存开销。</p>
<h3 id="jvm三类内置加载器">JVM三类内置加载器</h3>
<p>JVM提供了三层类加载器，形成了严格的层次结构：</p>
<ol type="1">
<li><p><strong>启动类加载器（Bootstrap
ClassLoader）</strong>：由C/C++实现，是JVM的一部分，负责加载Java核心类库（位于<code>%JRE_HOME%/lib</code>目录下的rt.jar、resources.jar等）。由于是底层实现，在Java代码中无法直接引用，获取其引用时返回null。</p></li>
<li><p><strong>扩展类加载器（Extension
ClassLoader）</strong>：由Java实现，继承自URLClassLoader，负责加载<code>%JRE_HOME%/lib/ext</code>目录下的扩展类库。其父加载器是Bootstrap
ClassLoader。</p></li>
<li><p><strong>应用程序类加载器（Application
Classloader）</strong>：也称为系统类加载器，负责加载用户类路径（classpath）上的类库。它是Java程序中默认的类加载器，通过<code>ClassLoader.getSystemClassLoader()</code>方法可以获取到它。</p></li>
</ol>
<pre class="mermaid">graph TD
    A[自定义类加载器] --&gt; B[应用程序类加载器]
    B --&gt; C[扩展类加载器]
    C --&gt; D[启动类加载器]
    D --&gt; E[null]</pre>
<h3 id="示例代码查看类加载器层次">示例代码：查看类加载器层次</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ClassLoaderHierarchy <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取当前类的类加载器（通常是AppClassLoader）</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> appClassLoader <span class="op">=</span> ClassLoaderHierarchy<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getClassLoader</span><span class="op">();</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;应用程序类加载器: &quot;</span> <span class="op">+</span> appClassLoader<span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取父加载器（ExtClassLoader）</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> extClassLoader <span class="op">=</span> appClassLoader<span class="op">.</span><span class="fu">getParent</span><span class="op">();</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;扩展类加载器: &quot;</span> <span class="op">+</span> extClassLoader<span class="op">);</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取启动类加载器（显示为null，因为由C++实现）</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> bootstrapClassLoader <span class="op">=</span> extClassLoader<span class="op">.</span><span class="fu">getParent</span><span class="op">();</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;启动类加载器: &quot;</span> <span class="op">+</span> bootstrapClassLoader<span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 查看核心类库的加载器</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;String类的加载器: &quot;</span> <span class="op">+</span> <span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getClassLoader</span><span class="op">());</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;DESKeyFactory类的加载器: &quot;</span> <span class="op">+</span> </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>            javax<span class="op">.</span><span class="fu">crypto</span><span class="op">.</span><span class="fu">DESKeyFactory</span><span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getClassLoader</span><span class="op">());</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="问题分析">问题分析</h3>
<p><strong>常见误解</strong>：许多开发者误认为类加载器之间存在继承关系，实际上它们之间是<strong>组合关系</strong>而非继承关系。每个类加载器实例内部包含一个对父加载器的引用，而非通过继承获取父类的功能。另一个常见误区是认为”双亲委派”意味着类加载器有”两个父母”，实际上”双亲”是指父加载器的单数形式，是一种误译。</p>
<p><strong>边界情况</strong>：当同一个类被不同的类加载器加载时，JVM会将其视为不同的类型，即使在磁盘上是同一个Class文件。这种机制虽然保证了类的隔离性，但也可能导致类型转换异常或资源重复加载的问题。</p>
<h2 id="类唯一限定名与命名空间">类唯一限定名与命名空间</h2>
<h3 id="概念解释-1">概念解释</h3>
<p>在Java中，类的<strong>完全限定名</strong>（Fully Qualified
Name）是指包括包名和类名的完整标识符，用于在整个项目中唯一标识一个类。例如，<code>java.lang.String</code>就是一个完全限定名，其中<code>java.lang</code>是包名，<code>String</code>是类名。这种命名机制是Java解决类命名冲突的核心策略，尤其在大型项目和团队协作中至关重要。</p>
<p>类名本身需要遵循Java的命名规范：必须以大写字母开头，采用驼峰命名法，只能包含字母、数字、下划线和美元符号，不能使用Java保留字。虽然从技术上讲，可以使用像”New”这样的类名（因为不是Java关键字），但按照约定，类名应该使用名词，并反映类的目的和功能。</p>
<h3 id="类加载器与命名空间">类加载器与命名空间</h3>
<p>每个类加载器实例都拥有一个独立的<strong>类命名空间</strong>，JVM中使用<strong>类全限定名
+
类加载器实例</strong>共同确定一个类的唯一性。这意味着即使相同的类文件，被不同的类加载器加载后，在JVM中也会被视为不同的类型。这种机制是实现类隔离和热加载的基础。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 示例：相同的类被不同类加载器加载后，被视为不同类型</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">ClassLoader</span> customLoader1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">CustomClassLoader</span><span class="op">();</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">ClassLoader</span> customLoader2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">CustomClassLoader</span><span class="op">();</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;</span> class1 <span class="op">=</span> customLoader1<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span><span class="st">&quot;com.example.Test&quot;</span><span class="op">);</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;</span> class2 <span class="op">=</span> customLoader2<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span><span class="st">&quot;com.example.Test&quot;</span><span class="op">);</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;是否为同一类型: &quot;</span> <span class="op">+</span> <span class="op">(</span>class1 <span class="op">==</span> class2<span class="op">));</span> <span class="co">// 输出 false</span></span></code></pre></div>
<h3 id="应用场景">应用场景</h3>
<p>在大型企业应用和微服务架构中，完全限定名的正确使用可以减少约70%的命名冲突几率。特别是在模块化系统和容器环境中，不同的模块可能需要加载同一类的不同版本，这时类加载器的命名空间机制就显得尤为重要。</p>
<h2 id="双亲委派机制深度解析">双亲委派机制深度解析</h2>
<h3 id="工作原理">工作原理</h3>
<p><strong>双亲委派模型</strong>是JVM类加载的核心机制。当一个类加载器收到类加载请求时，它首先不会自己尝试加载，而是将请求委派给父类加载器处理，如此递归，直到传送到顶层的启动类加载器。只有当所有父加载器都无法完成加载请求时（在各自的搜索范围内没找到所需类），子加载器才会尝试自己加载。</p>
<p>这种机制通过ClassLoader类的loadClass()方法实现，其核心逻辑如下：</p>
<ol type="1">
<li>检查类是否已被加载，避免重复加载</li>
<li>如果父加载器存在，委托父加载器加载</li>
<li>如果父加载器为null，委托启动类加载器加载</li>
<li>如果父加载器都加载失败，调用自己的findClass()方法加载</li>
</ol>
<pre class="mermaid">flowchart TD
    A[类加载请求] --&gt; B{是否已加载}
    B -- 是 --&gt; C[返回已加载的类]
    B -- 否 --&gt; D{父加载器是否存在}
    D -- 是 --&gt; E[委托父加载器处理]
    D -- 否 --&gt; F[委托启动类加载器]
    E --&gt; G{父加载器是否加载成功}
    F --&gt; G
    G -- 是 --&gt; C
    G -- 否 --&gt; H[调用自身的findClass方法]
    H --&gt; I[加载类并返回]</pre>
<h3 id="源码分析">源码分析</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">loadClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">,</span> <span class="dt">boolean</span> resolve<span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">synchronized</span> <span class="op">(</span><span class="fu">getClassLoadingLock</span><span class="op">(</span>name<span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 首先，检查是否已经加载过</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Class</span><span class="op">&lt;?&gt;</span> c <span class="op">=</span> <span class="fu">findLoadedClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">long</span> t0 <span class="op">=</span> <span class="bu">System</span><span class="op">.</span><span class="fu">nanoTime</span><span class="op">();</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>parent <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// 父加载器不为空，委托父加载器加载</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                    c <span class="op">=</span> parent<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span>name<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// 父加载器为空，委托启动类加载器加载</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                    c <span class="op">=</span> <span class="fu">findBootstrapClassOrNull</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">ClassNotFoundException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 父加载器无法加载，抛出异常</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 父加载器未能加载，调用自身的findClass方法</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                <span class="dt">long</span> t1 <span class="op">=</span> <span class="bu">System</span><span class="op">.</span><span class="fu">nanoTime</span><span class="op">();</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> <span class="fu">findClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 记录统计信息</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>resolve<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">resolveClass</span><span class="op">(</span>c<span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> c<span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="设计意义与三次破坏">设计意义与三次破坏</h3>
<p>双亲委派机制的主要优势包括：</p>
<ol type="1">
<li><strong>安全性</strong>：防止核心API被篡改，确保Java程序安全。例如，自定义的java.lang.String类不会被加载，因为启动类加载器会优先加载核心库中的String类。</li>
<li><strong>一致性</strong>：避免类的重复加载，保证类的唯一性。</li>
<li><strong>灵活性</strong>：为自定义类加载器提供了扩展空间。</li>
</ol>
<p>然而，在Java发展过程中，双亲委派机制经历了三次主要破坏：</p>
<ol type="1">
<li><strong>JDBC
SPI机制</strong>：通过线程上下文类加载器打破双亲委派，使核心库能加载实现类。</li>
<li><strong>OSGi模块化系统</strong>：实现网络状的类加载器架构，支持模块化热部署。</li>
<li><strong>热部署需求</strong>：在应用服务器中实现类的动态更新。</li>
</ol>
<h3 id="问题分析-1">问题分析</h3>
<p><strong>常见误区</strong>：开发者常常认为双亲委派模型是强制性的，实际上它只是ClassLoader的一种实现模式，开发者可以重写loadClass()方法来改变此行为。但这样做需要谨慎，因为可能破坏Java的安全模型。</p>
<p><strong>性能考量</strong>：双亲委派机制通过缓存已加载的类来提高性能。JVM会缓存已加载的类，当程序需要使用某个类时，类加载器先从缓存区中搜寻，只有当缓存中不存在时，才会读取类的二进制数据。</p>
<h2 id="自定义类加载器实现">自定义类加载器实现</h2>
<h3 id="实现步骤">实现步骤</h3>
<p>创建自定义类加载器需要遵循以下步骤：</p>
<ol type="1">
<li>继承java.lang.ClassLoader类</li>
<li>重写findClass()方法，实现自定义类加载逻辑</li>
<li>在findClass()中调用defineClass()方法将字节数组转换为Class对象</li>
</ol>
<p>这种设计允许开发者专注于类的获取逻辑，而不必重写整个加载流程。findClass()方法是在loadClass()方法中被调用的，当父加载器无法加载类时，会自动调用子类的findClass()方法。</p>
<h3 id="完整示例代码">完整示例代码</h3>
<p>以下是一个从文件系统加载类的自定义类加载器实现：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.*;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> FileSystemClassLoader <span class="kw">extends</span> <span class="bu">ClassLoader</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> classPath<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">FileSystemClassLoader</span><span class="op">(</span><span class="bu">String</span> classPath<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 指定父加载器为系统类加载器</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span><span class="bu">ClassLoader</span><span class="op">.</span><span class="fu">getSystemClassLoader</span><span class="op">());</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">classPath</span> <span class="op">=</span> classPath<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">findClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> classData <span class="op">=</span> <span class="fu">loadClassData</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>classData <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">ClassNotFoundException</span><span class="op">();</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 将字节数组转换为Class对象</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">defineClass</span><span class="op">(</span>name<span class="op">,</span> classData<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> classData<span class="op">.</span><span class="fu">length</span><span class="op">);</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">ClassNotFoundException</span><span class="op">(</span><span class="st">&quot;类加载失败: &quot;</span> <span class="op">+</span> name<span class="op">,</span> e<span class="op">);</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">loadClassData</span><span class="op">(</span><span class="bu">String</span> className<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 将类名转换为文件路径</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> path <span class="op">=</span> <span class="fu">classNameToPath</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span><span class="bu">InputStream</span> ins <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileInputStream</span><span class="op">(</span>path<span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>             <span class="bu">ByteArrayOutputStream</span> baos <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteArrayOutputStream</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> buffer <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">4096</span><span class="op">];</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> bytesRead<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">((</span>bytesRead <span class="op">=</span> ins<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">))</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                baos<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> bytesRead<span class="op">);</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> baos<span class="op">.</span><span class="fu">toByteArray</span><span class="op">();</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">classNameToPath</span><span class="op">(</span><span class="bu">String</span> className<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 将包名中的点替换为文件分隔符，并添加.class扩展名</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> classPath <span class="op">+</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separatorChar</span> <span class="op">+</span> </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>               className<span class="op">.</span><span class="fu">replace</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">,</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separatorChar</span><span class="op">)</span> <span class="op">+</span> <span class="st">&quot;.class&quot;</span><span class="op">;</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="使用自定义类加载器">使用自定义类加载器</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CustomClassLoaderDemo <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 创建自定义类加载器，指定类路径为D:/lib</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        FileSystemClassLoader classLoader <span class="op">=</span> <span class="kw">new</span> <span class="fu">FileSystemClassLoader</span><span class="op">(</span><span class="st">&quot;D:/lib&quot;</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 使用自定义类加载器加载类</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz <span class="op">=</span> classLoader<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span><span class="st">&quot;com.example.Test&quot;</span><span class="op">);</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 创建实例并调用方法</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> instance <span class="op">=</span> clazz<span class="op">.</span><span class="fu">newInstance</span><span class="op">();</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Method</span> method <span class="op">=</span> clazz<span class="op">.</span><span class="fu">getMethod</span><span class="op">(</span><span class="st">&quot;sayHello&quot;</span><span class="op">);</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        method<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 查看类加载器信息</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Test类的加载器: &quot;</span> <span class="op">+</span> clazz<span class="op">.</span><span class="fu">getClassLoader</span><span class="op">());</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;父加载器: &quot;</span> <span class="op">+</span> clazz<span class="op">.</span><span class="fu">getClassLoader</span><span class="op">().</span><span class="fu">getParent</span><span class="op">());</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="应用场景-1">应用场景</h3>
<p>自定义类加载器在以下场景中发挥重要作用：</p>
<ol type="1">
<li><strong>代码加密</strong>：对类文件进行加密，运行时通过自定义类加载器解密</li>
<li><strong>模块化加载</strong>：从非标准位置（数据库、网络）动态加载模块</li>
<li><strong>版本隔离</strong>：在同一JVM中运行同一类的不同版本</li>
<li><strong>热部署</strong>：在不重启JVM的情况下更新类定义</li>
</ol>
<h3 id="问题与解决方案">问题与解决方案</h3>
<p><strong>内存泄漏风险</strong>：类加载器会持有对它所加载的所有Class对象的引用，如果类加载器本身没有被正确释放，可能导致内存泄漏。解决方案是确保类加载器的生命周期与应用需求一致，及时解除引用。</p>
<p><strong>类加载冲突</strong>：在多类加载器环境下，可能出现类转换异常或方法调用错误。应确保良好的类加载器层次结构设计，遵循双亲委派原则，或者在明确需要隔离时彻底打破委派模型。</p>
<h2 id="热加载原理与实现">热加载原理与实现</h2>
<h3 id="为什么默认类加载器不能热加载">为什么默认类加载器不能热加载</h3>
<p>JVM默认的类加载器（特别是AppClassLoader）遵循<strong>双亲委派模型</strong>且具有<strong>缓存机制</strong>，这是导致其无法实现热加载的根本原因。</p>
<ol type="1">
<li><p><strong>类缓存机制</strong>：每个类加载器会缓存已经加载的类，在收到类加载请求时，首先检查缓存中是否已存在该类。如果存在，直接返回缓存的Class对象，不会重新加载。</p></li>
<li><p><strong>双亲委派优先</strong>：即使我们试图重新加载某个类，类加载请求也会先委派给父加载器，而父加载器会返回已缓存的类定义。</p></li>
<li><p><strong>永久代/元空间限制</strong>：在传统JVM架构中，类元数据存放在永久代（JDK7及之前）或元空间（JDK8+）中，已加载的类无法被卸载，除非对应的类加载器被垃圾回收。</p></li>
</ol>
<div class="sourceCode" id="cb8"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 演示默认类加载器的缓存行为</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">ClassLoader</span> systemLoader <span class="op">=</span> <span class="bu">ClassLoader</span><span class="op">.</span><span class="fu">getSystemClassLoader</span><span class="op">();</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz1 <span class="op">=</span> systemLoader<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span><span class="st">&quot;com.example.Test&quot;</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz2 <span class="op">=</span> systemLoader<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span><span class="st">&quot;com.example.Test&quot;</span><span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;两次加载是否为同一类: &quot;</span> <span class="op">+</span> <span class="op">(</span>clazz1 <span class="op">==</span> clazz2<span class="op">));</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">// 输出 true，证明类被缓存了</span></span></code></pre></div>
<h3 id="热加载的实现原理">热加载的实现原理</h3>
<p>实现热加载的关键在于<strong>打破双亲委派模型</strong>和<strong>避免类缓存</strong>的影响。核心思路是每次需要热加载时，创建一个新的类加载器实例，通过这个新加载器加载修改后的类。</p>
<p>热加载的基本原理如下：</p>
<ol type="1">
<li>监控类文件的变化（时间戳、MD5校验等）</li>
<li>当检测到类文件发生变化时，创建新的类加载器实例</li>
<li>使用新的类加载器加载修改后的类</li>
<li>创建新类的实例，并逐步替换旧实例的引用</li>
</ol>
<h3 id="完整热加载实现">完整热加载实现</h3>
<p>以下是一个简单的热加载器实现，监控指定目录下的类文件变化：</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HotSwapClassLoader <span class="kw">extends</span> <span class="bu">ClassLoader</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> classPath<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Long</span><span class="op">&gt;</span> classModifiedMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HotSwapClassLoader</span><span class="op">(</span><span class="bu">String</span> classPath<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span> <span class="co">// 指定父加载器为null，打破双亲委派</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">classPath</span> <span class="op">=</span> classPath<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">monitorClassFiles</span><span class="op">();</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">loadClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">,</span> <span class="dt">boolean</span> resolve<span class="op">)</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 对于需要热加载的类，打破双亲委派</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>name<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;com.hotswap&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">findClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 其他类仍遵循双亲委派</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">super</span><span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span>name<span class="op">,</span> resolve<span class="op">);</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">findClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> classData <span class="op">=</span> <span class="fu">loadClassData</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>classData <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">ClassNotFoundException</span><span class="op">();</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">defineClass</span><span class="op">(</span>name<span class="op">,</span> classData<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> classData<span class="op">.</span><span class="fu">length</span><span class="op">);</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">ClassNotFoundException</span><span class="op">(</span><span class="st">&quot;热加载失败: &quot;</span> <span class="op">+</span> name<span class="op">,</span> e<span class="op">);</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">loadClassData</span><span class="op">(</span><span class="bu">String</span> className<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> path <span class="op">=</span> <span class="fu">classNameToPath</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>path<span class="op">);</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>file<span class="op">.</span><span class="fu">exists</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 检查文件是否被修改</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> lastModified <span class="op">=</span> file<span class="op">.</span><span class="fu">lastModified</span><span class="op">();</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> lastLoaded <span class="op">=</span> classModifiedMap<span class="op">.</span><span class="fu">get</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>lastLoaded <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> lastLoaded <span class="op">==</span> lastModified<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 文件未修改，可以返回null触发重新加载，或者维护已加载类的缓存</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 这里为了简化，每次都会重新加载</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span><span class="bu">InputStream</span> ins <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileInputStream</span><span class="op">(</span>file<span class="op">);</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>             <span class="bu">ByteArrayOutputStream</span> baos <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteArrayOutputStream</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> buffer <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">4096</span><span class="op">];</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> bytesRead<span class="op">;</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">((</span>bytesRead <span class="op">=</span> ins<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">))</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>                baos<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> bytesRead<span class="op">);</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 记录加载时间</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>            classModifiedMap<span class="op">.</span><span class="fu">put</span><span class="op">(</span>className<span class="op">,</span> lastModified<span class="op">);</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> baos<span class="op">.</span><span class="fu">toByteArray</span><span class="op">();</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">monitorClassFiles</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 启动监控线程，定期检查类文件变化</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Thread</span> monitorThread <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">2000</span><span class="op">);</span> <span class="co">// 每2秒检查一次</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">checkForUpdates</span><span class="op">();</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        monitorThread<span class="op">.</span><span class="fu">setDaemon</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>        monitorThread<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">checkForUpdates</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 检查类文件是否被修改，如果修改则触发重加载</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> className <span class="op">:</span> classModifiedMap<span class="op">.</span><span class="fu">keySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> path <span class="op">=</span> <span class="fu">classNameToPath</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>            <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>path<span class="op">);</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>file<span class="op">.</span><span class="fu">exists</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>                <span class="dt">long</span> lastModified <span class="op">=</span> file<span class="op">.</span><span class="fu">lastModified</span><span class="op">();</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Long</span> lastLoaded <span class="op">=</span> classModifiedMap<span class="op">.</span><span class="fu">get</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>lastLoaded <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> lastModified <span class="op">&gt;</span> lastLoaded<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;检测到类文件变化: &quot;</span> <span class="op">+</span> className<span class="op">);</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// 触发重加载逻辑</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">onClassReload</span><span class="op">(</span>className<span class="op">);</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">onClassReload</span><span class="op">(</span><span class="bu">String</span> className<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 在实际应用中，这里需要通知应用程序进行适当的实例替换</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;准备重新加载类: &quot;</span> <span class="op">+</span> className<span class="op">);</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>            <span class="fu">findClass</span><span class="op">(</span>className<span class="op">);</span> <span class="co">// 重新加载类</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">ClassNotFoundException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;重加载失败: &quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">classNameToPath</span><span class="op">(</span><span class="bu">String</span> className<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> classPath <span class="op">+</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separatorChar</span> <span class="op">+</span> </span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>               className<span class="op">.</span><span class="fu">replace</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">,</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separatorChar</span><span class="op">)</span> <span class="op">+</span> <span class="st">&quot;.class&quot;</span><span class="op">;</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="热加载的挑战与解决方案">热加载的挑战与解决方案</h3>
<p><strong>状态保持问题</strong>：热加载类后，旧实例的状态如何迁移到新实例是一个复杂问题。解决方案包括：</p>
<ol type="1">
<li><strong>序列化/反序列化</strong>：将旧实例状态序列化，新实例反序列化恢复</li>
<li><strong>状态提取与注入</strong>：提取关键状态数据，注入到新实例中</li>
<li><strong>渐进式更新</strong>：创建新实例，逐步接管旧实例的功能</li>
</ol>
<p><strong>资源清理问题</strong>：旧类创建的线程、打开的连接等资源需要妥善处理。解决方案包括：</p>
<ol type="1">
<li><strong>资源代理模式</strong>：通过代理管理资源，热加载时只替换业务逻辑</li>
<li><strong>优雅关闭</strong>：通知旧实例进行资源清理，然后再创建新实例</li>
</ol>
<div class="sourceCode" id="cb10"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 资源代理示例</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ResourceManager <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">volatile</span> <span class="bu">Service</span> service<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> serviceState<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">updateService</span><span class="op">(</span><span class="bu">Service</span> newService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 保存状态</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>service <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            serviceState <span class="op">=</span> service<span class="op">.</span><span class="fu">extractState</span><span class="op">();</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            service<span class="op">.</span><span class="fu">cleanup</span><span class="op">();</span> <span class="co">// 清理资源</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 恢复状态到新实例</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        newService<span class="op">.</span><span class="fu">restoreState</span><span class="op">(</span>serviceState<span class="op">);</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        service <span class="op">=</span> newService<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2
id="实战案例spring框架中的热部署">实战案例：Spring框架中的热部署</h2>
<h3 id="spring-devtools热部署原理">Spring DevTools热部署原理</h3>
<p>Spring Boot
DevTools是热部署的经典实现，它通过自定义类加载器和运行时重启机制实现快速应用更新。其核心原理是将应用代码和第三方依赖分离到不同的类加载器中。</p>
<p>DevTools使用两个类加载器： 1. <strong>Base
ClassLoader</strong>：加载不变化的第三方依赖库 2. <strong>Restart
ClassLoader</strong>：加载应用代码，支持热替换</p>
<p>当检测到类文件变化时，DevTools会创建一个新的Restart
ClassLoader，重新加载应用类，而基类加载器保持不变，大大提高了重启速度。</p>
<h3 id="类加载器配置示例">类加载器配置示例</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 简化的Spring类加载器结构</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringClassLoader <span class="kw">extends</span> <span class="bu">URLClassLoader</span> <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">ClassLoader</span> parentLoader<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">SpringClassLoader</span><span class="op">(</span><span class="bu">URL</span><span class="op">[]</span> urls<span class="op">,</span> <span class="bu">ClassLoader</span> parent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span>urls<span class="op">,</span> <span class="kw">null</span><span class="op">);</span> <span class="co">// 指定父加载器为null，打破双亲委派</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">parentLoader</span> <span class="op">=</span> parent<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">loadClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">,</span> <span class="dt">boolean</span> resolve<span class="op">)</span> </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. 检查类是否已加载</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz <span class="op">=</span> <span class="fu">findLoadedClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>clazz <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> clazz<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. 排除特定包名不热加载（如第三方库）</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>name<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;org.springframework&quot;</span><span class="op">)</span> <span class="op">||</span> </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            name<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;com.fasterxml&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> parentLoader<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. 尝试自己加载应用类</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>            clazz <span class="op">=</span> <span class="fu">findClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>clazz <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> clazz<span class="op">;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">ClassNotFoundException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 忽略，委托给父加载器</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. 委托给父加载器</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> parentLoader<span class="op">.</span><span class="fu">loadClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="热部署在微服务架构中的应用">热部署在微服务架构中的应用</h3>
<p>在微服务架构中，热部署技术可以显著提高开发效率。通过将热部署与容器化技术结合，可以实现更高级别的动态更新能力：</p>
<ol type="1">
<li><strong>金丝雀发布</strong>：热加载新版本到部分实例，逐步验证</li>
<li><strong>A/B测试</strong>：同时运行多个版本，根据业务指标选择最优版本</li>
<li><strong>快速回滚</strong>：检测到问题迅速热加载回旧版本</li>
</ol>
<h3 id="性能优化建议">性能优化建议</h3>
<p>热加载技术虽然强大，但需要谨慎使用以避免性能问题：</p>
<ol type="1">
<li><strong>类缓存策略</strong>：合理设置类缓存大小和过期时间</li>
<li><strong>监控频率</strong>：根据项目规模调整文件监控频率</li>
<li><strong>内存管理</strong>：及时清理不再使用的类加载器，避免内存泄漏</li>
<li><strong>增量加载</strong>：只重新加载真正发生变化的类</li>
</ol>
<h2 id="总结">总结</h2>
<ol type="1">
<li><p><strong>类加载器层次</strong>：JVM通过启动类加载器、扩展类加载器和应用程序类加载器形成分层结构，每层负责不同范围的类加载任务。</p></li>
<li><p><strong>双亲委派机制</strong>：通过先将加载请求委派给父加载器，确保核心类库的安全性和类的唯一性，是Java安全模型的基石。</p></li>
<li><p><strong>类唯一性</strong>：JVM中类的唯一性由<strong>全限定名 +
类加载器实例</strong>共同决定，这为类隔离和热加载提供了理论基础。</p></li>
<li><p><strong>热加载实现</strong>：通过打破双亲委派模型、创建新的类加载器实例，并妥善处理状态迁移和资源清理，可以实现类的热加载功能。</p></li>
<li><p><strong>应用场景</strong>：热加载技术在开发调试、应用服务器、微服务架构中具有重要价值，能显著提高开发效率和系统可用性。</p></li>
</ol>
<h2 id="延伸阅读">延伸阅读</h2>
<ol type="1">
<li><strong>官方文档</strong>
<ul>
<li>https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html</li>
<li>https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html</li>
</ul></li>
<li><strong>经典书籍</strong>
<ul>
<li>《深入理解Java虚拟机》- 周志明</li>
<li>《Java虚拟机规范》</li>
<li>《The Java Virtual Machine Specification》</li>
</ul></li>
<li><strong>源码参考</strong>
<ul>
<li>http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/tip/src/share/classes/java/lang/ClassLoader.java</li>
<li>https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-devtools</li>
</ul></li>
</ol>
<h2 id="一句话记忆">一句话记忆</h2>
<blockquote>
<p>JVM类唯一性由类全限定名和加载器实例共同确定，热加载通过创建新的类加载器打破双亲委派实现，但需妥善处理状态迁移和资源清理。</p>
</blockquote>
</div>
    </article>
  </div>
  <aside class="toc-sidebar" id="toc-sidebar">
    <div class="toc-header">
      <h3>文章目录</h3>
    </div>
    <nav class="toc-nav" id="toc-nav">
      <!-- 目录内容将通过JavaScript自动生成 -->
    </nav>
  </aside>
</div>

<script>
  // Add copy buttons to code blocks
  function addCopyButtons() {
    const sourceCodeBlocks = document.querySelectorAll(".sourceCode");
    sourceCodeBlocks.forEach(function (block) {
      if (block.querySelector(".copy-button")) return;
      const preElement = block.querySelector("pre");
      if (!preElement) return;

      const button = document.createElement("button");
      button.className = "copy-button";
      button.textContent = "复制";
      button.setAttribute("aria-label", "复制代码");

      button.addEventListener("click", function () {
        const code = preElement.querySelector("code");
        const text = code ? code.innerText : preElement.innerText;

        navigator.clipboard
          .writeText(text)
          .then(function () {
            button.textContent = "已复制";
            button.classList.add("copied");

            setTimeout(function () {
              button.textContent = "复制";
              button.classList.remove("copied");
            }, 3000);
          })
          .catch(function (err) {
            console.error("复制失败: ", err);
            button.textContent = "失败";
            setTimeout(function () {
              button.textContent = "复制";
            }, 3000);
          });
      });

      block.appendChild(button);
    });

    const allPreBlocks = document.querySelectorAll("pre:not(.mermaid)");
    allPreBlocks.forEach(function (block) {
      if (block.closest(".sourceCode") || block.querySelector(".copy-button"))
        return;

      const button = document.createElement("button");
      button.className = "copy-button";
      button.textContent = "复制";
      button.setAttribute("aria-label", "复制代码");

      button.addEventListener("click", function () {
        const code = block.querySelector("code");
        const text = code ? code.innerText : block.innerText;

        navigator.clipboard
          .writeText(text)
          .then(function () {
            button.textContent = "已复制";
            button.classList.add("copied");

            setTimeout(function () {
              button.textContent = "复制";
              button.classList.remove("copied");
            }, 3000);
          })
          .catch(function (err) {
            console.error("复制失败: ", err);
            button.textContent = "失败";
            setTimeout(function () {
              button.textContent = "复制";
            }, 3000);
          });
      });

      block.appendChild(button);
    });
  }

  // 生成文章目录
  function generateTableOfContents() {
    const postContent = document.getElementById("post-content");
    const tocNav = document.getElementById("toc-nav");

    if (!postContent || !tocNav) {
      console.log("Missing postContent or tocNav element");
      return;
    }

    // 查找所有标题元素
    const headings = postContent.querySelectorAll("h1, h2, h3, h4, h5, h6");
    console.log("Found headings:", headings.length);

    if (headings.length === 0) {
      // 如果没有标题，隐藏目录
      console.log("No headings found, hiding TOC");
      const tocSidebar = document.getElementById("toc-sidebar");
      if (tocSidebar) tocSidebar.style.display = "none";
      return;
    }

    // 清空目录容器
    tocNav.innerHTML = "";

    // 创建目录结构
    const tocList = document.createElement("ul");
    tocList.className = "toc-list";

    let currentLevel = 1;
    let currentList = tocList;
    let listStack = [tocList];

    headings.forEach((heading, index) => {
      // 强制为每个标题设置标准化的ID（始终重写现有ID）
      const normalizedId = "heading-" + index;
      heading.id = normalizedId;

      const level = parseInt(heading.tagName.charAt(1));
      const title = heading.textContent.trim();

      // 创建目录项
      const tocItem = document.createElement("li");
      tocItem.className = "toc-item toc-level-" + level;

      const tocLink = document.createElement("a");
      tocLink.href = "javascript:void(0)"; // 避免触发路由
      tocLink.setAttribute("data-target", heading.id); // 存储目标ID
      tocLink.textContent = title;
      tocLink.className = "toc-link";

      tocItem.appendChild(tocLink);

      // 处理层级关系
      if (level > currentLevel) {
        // 创建新的子列表
        const newList = document.createElement("ul");
        newList.className = "toc-sublist";
        // 检查是否有父元素
        const parentList = listStack[listStack.length - 1];
        if (parentList.lastElementChild) {
          parentList.lastElementChild.appendChild(newList);
        } else {
          // 如果没有父元素，直接添加到当前列表
          parentList.appendChild(newList);
        }
        listStack.push(newList);
        currentList = newList;
      } else if (level < currentLevel) {
        // 返回到上一级
        while (listStack.length > level) {
          listStack.pop();
        }
        currentList = listStack[listStack.length - 1];
      }

      currentList.appendChild(tocItem);
      currentLevel = level;
    });

    tocNav.appendChild(tocList);
    console.log("TOC generated successfully");

    // 高亮当前章节
    highlightCurrentSection();

    // 滚动监听
    window.addEventListener("scroll", highlightCurrentSection);

    // 为目录链接添加点击事件
    setTimeout(() => {
      const tocLinks = document.querySelectorAll(".toc-link");
      tocLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const targetId = link.getAttribute("data-target");
          if (targetId) {
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({
                behavior: "smooth",
                block: "start",
                inline: "nearest",
              });
            }
          }
        });
      });
    }, 200); // 延迟确保目录已生成
  }

  // 高亮当前阅读的章节
  function highlightCurrentSection() {
    const headings = document.querySelectorAll(
      ".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6"
    );
    const tocLinks = document.querySelectorAll(".toc-link");

    let currentHeading = null;
    const scrollPosition = window.pageYOffset + 100;

    // 找到当前可见的标题
    for (let i = headings.length - 1; i >= 0; i--) {
      if (headings[i].offsetTop <= scrollPosition) {
        currentHeading = headings[i];
        break;
      }
    }

    // 清除所有活动状态
    tocLinks.forEach((link) => link.classList.remove("active"));

    // 高亮当前章节
    if (currentHeading) {
      const activeLink = document.querySelector(
        '.toc-link[data-target="' + currentHeading.id + '"]'
      );
      if (activeLink) {
        activeLink.classList.add("active");
      }
    }
  }

  // Initialize mermaid diagrams - 只在直接访问 fragment 时运行
  async function initMermaid() {
    // 检查是否在 SPA 环境中
    if (window.IN_SPA_MODE === true) {
      console.log(
        "[Mermaid Fragment] In SPA mode, skipping fragment initialization"
      );
      return;
    }

    if (typeof mermaid === "undefined") {
      console.log("[Mermaid Fragment] Library not loaded");
      return;
    }

    const mermaidPreElements = document.querySelectorAll(
      "pre.mermaid, div.mermaid"
    );
    if (mermaidPreElements.length === 0) {
      console.log("[Mermaid Fragment] No diagrams found");
      return;
    }

    console.log(
      "[Mermaid Fragment] 找到",
      mermaidPreElements.length,
      "个 Mermaid 图表，准备渲染..."
    );

    // 处理 DOM 结构
    const elementsToRun = [];

    mermaidPreElements.forEach((element) => {
      // 获取原始图表代码
      const graphDefinition = element.textContent.trim();
      console.log(
        "[Mermaid Fragment] First 100 chars:",
        graphDefinition.substring(0, 100)
      );

      // 创建一个新的 div 来替换旧的 pre/div，确保它是"干净"的
      const newDiv = document.createElement("div");
      newDiv.className = "mermaid";
      newDiv.textContent = graphDefinition;
      newDiv.setAttribute("data-mermaid-code", graphDefinition);

      element.parentNode.replaceChild(newDiv, element);
      elementsToRun.push(newDiv);
    });

    // 手动触发渲染
    try {
      await mermaid.run({
        nodes: elementsToRun,
      });
      console.log("[Mermaid Fragment] 渲染完成");
    } catch (err) {
      console.error("[Mermaid Fragment] 渲染失败:", err);
      // 出错时显示原始代码，避免白屏
      elementsToRun.forEach((el) => {
        el.style.whiteSpace = "pre";
        el.style.border = "1px solid red";
      });
    }
  }

  // Initialize copy buttons and TOC after content loads
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      console.log("DOM loading, initializing...");
      addCopyButtons();
      setTimeout(generateTableOfContents, 100);
      setTimeout(initMermaid, 200);
    });
  } else {
    console.log("DOM already loaded, initializing...");
    addCopyButtons();
    setTimeout(generateTableOfContents, 100);
    setTimeout(initMermaid, 200);
  }
</script>
