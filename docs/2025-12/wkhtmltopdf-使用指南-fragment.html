<style>
  /* CSS Variables for fragment */
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --bg-color: #f8f9fa;
    --text-color: #34495e;
    --border-color: #e9ecef;
    --card-bg: #ffffff;
  }

  /* TOC Sidebar Styles */
  .article-layout {
    display: flex;
    max-width: 1400px;
    margin: 0 auto;
    gap: 30px;
    padding: 0 20px;
  }

  .main-content {
    flex: 1;
    min-width: 0;
  }

  .toc-sidebar {
    width: 280px;
    flex-shrink: 0;
    position: sticky;
    top: 20px;
    height: fit-content;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .toc-header h3 {
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 10px;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 8px;
  }

  .toc-link {
    display: block;
    padding: 6px 10px;
    color: var(--text-color);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }

  .toc-link:hover {
    background: var(--secondary-color);
    color: white;
    padding-left: 15px;
  }

  .toc-link.active {
    background: var(--secondary-color);
    color: white;
    font-weight: 500;
  }

  .toc-sublist {
    list-style: none;
    padding-left: 20px;
    margin-top: 5px;
  }

  .toc-sublist .toc-link {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  /* Post Styles */
  .post {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
  }

  .post-header {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
  }

  .post-title {
    color: var(--primary-color);
    font-size: 2rem;
    margin-bottom: 15px;
  }

  .post-meta {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 0.95rem;
    color: #6c757d;
  }

  .post-date {
    background-color: #e3f2fd;
    color: var(--secondary-color);
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 500;
  }

  .post-category {
    background-color: #e8f5e9;
    color: #4caf50;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 500;
  }

  .warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 30px;
    text-align: center;
    font-size: 0.9rem;
  }

  .post-content {
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--text-color);
  }

  .post-content h1,
  .post-content h2,
  .post-content h3,
  .post-content h4,
  .post-content h5,
  .post-content h6 {
    color: var(--primary-color);
    margin-top: 35px;
    margin-bottom: 20px;
    scroll-margin-top: 20px;
  }

  .post-content h2 {
    font-size: 1.5rem;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }

  .post-content h3 {
    font-size: 1.3rem;
    color: #2980b9;
  }

  .post-content p {
    margin-bottom: 18px;
  }

  .post-content code {
    background-color: #e8eaed;
    padding: 3px 7px;
    border-radius: 4px;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier,
      monospace;
    color: #c0392b;
    font-size: 0.9em;
  }

  .post-content pre {
    background-color: #2d2d2d;
    color: #f8f8f2;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 25px 0;
    font-size: 0.9em;
    line-height: 1.5;
    position: relative;
  }

  .post-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  .copy-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #3498db;
    border: 1px solid #2980b9;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 10;
  }

  .copy-button:hover {
    background: #2980b9;
    border-color: #2471a3;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .copy-button.copied {
    background: #4caf50;
    border-color: #4caf50;
  }

  /* Mermaid diagram styles */
  .mermaid {
    background-color: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin: 25px 0;
    text-align: center;
  }

  /* TABLE STYLES */
  .post-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border-radius: 8px;
  }

  .post-content table th,
  .post-content table td {
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    text-align: left;
  }

  /* 确保表格头部样式正确 */
  .post-content table thead {
    background-color: var(--secondary-color);
    color: white;
  }

  /* 覆盖pandoc生成的.header类样式 */
  .post-content table tr.header {
    background-color: var(--secondary-color) !important;
    color: white !important;
  }

  .post-content table tr.header th {
    color: white !important;
  }

  .post-content table tbody tr:nth-of-type(even) {
    background-color: rgba(233, 236, 239, 0.5);
  }

  .post-content table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.1);
  }

  /* 响应式表格 */
  @media (max-width: 768px) {
    .post-content table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .article-layout {
      flex-direction: column;
    }

    .toc-sidebar {
      width: 100%;
      position: static;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .post {
      padding: 20px;
    }

    .post-title {
      font-size: 1.6rem;
    }

    .post-content {
      font-size: 1rem;
    }

    .article-layout {
      padding: 0 15px;
    }
  }
</style>

<!-- 引入本地 Mermaid 库 -->
<script src="../../js/mermaid.min.js"></script>
<script>
  // 关键修复：初始化时立即禁止自动渲染
  if (typeof mermaid !== "undefined") {
    mermaid.initialize({
      startOnLoad: false,
      theme: "default",
      securityLevel: "loose",
    });
  }
</script>

<div class="article-layout">
  <div class="main-content">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">wkhtmltopdf 完整使用指南：从基础到高级技巧</h1>
        <div class="post-meta">
          <div class="post-date">2025/12/8</div>
          <div class="post-category">2025-12</div>
        </div>
      </header>
      <div class="warning">
        ⚠️ 注意：此内容由 AI 协助生成，准确性未经验证，请谨慎使用
      </div>
      <div class="post-content" id="post-content"><h2 id="wkhtmltopdf-简介">1 wkhtmltopdf 简介</h2>
<p>wkhtmltopdf 是一个开源（LGPLv3 协议）的命令行工具，用于将 HTML
文档转换为 PDF 格式，同时还支持将 HTML 转换为各种图像格式。该工具基于 Qt
WebKit
渲染引擎，能够在无界面（headless）环境下运行，不需要显示服务或图形界面支持。这意味着它可以在服务器环境中稳定工作，为
Web 应用提供强大的 PDF 生成能力。</p>
<p>与许多基于 Gecko 或 Trident 引擎的 HTML 转 PDF 工具不同，wkhtmltopdf
使用与 Safari 和早期 Chrome 浏览器相同的 WebKit 引擎，这确保了它对现代
Web 标准的良好支持。工具采用 C++编写，并提供了 C
库接口，允许开发者进行更深层次的集成和定制。除了主要的 wkhtmltopdf
工具外，项目还包含 wkhtmltoimage
用于生成图像截图，满足不同场景下的需求。</p>
<p>wkhtmltopdf
的核心优势在于其<strong>高质量的输出保真度</strong>，能够将 CSS
样式、JavaScript 生成的动态内容以及 SVG 图像等复杂内容准确呈现在 PDF
中。不同于简单的 HTML 到 PDF
转换，它实际上是一个<strong>无头浏览器</strong>，能够执行页面中的
JavaScript
代码，并在完成所有动态操作后执行渲染，这对于单页面应用(SPA)或富含交互内容的页面特别有用。</p>
<p>在实际应用中，wkhtmltopdf
被广泛用于生成发票、报告、文档存档、电子书等多种场景。许多流行的 Web
框架（如 Django、Rails）都有集成了 wkhtmltopdf 的插件或插件，使其成为
Web 开发中生成 PDF 的首选方案之一。</p>
<h2 id="安装与配置">2 安装与配置</h2>
<h3 id="系统要求与下载">2.1 系统要求与下载</h3>
<p>wkhtmltopdf 支持所有主流操作系统，包括 Windows、Linux 和
macOS。在选择版本时，应注意选择稳定版本以获得最佳兼容性。官方下载页面提供了多种预编译二进制文件，用户可根据自己的操作系统和架构选择合适版本。</p>
<p>对于 Linux
用户，除了下载预编译的二进制文件外，还可以通过包管理器安装。例如，在
CentOS/RHEL 系统上，可以使用 RPM 包进行安装；而在 Debian/Ubuntu
系统上，则可以使用 DEB 包。Windows 用户可以直接下载 EXE
安装程序，按照图形界面指引完成安装。</p>
<h3 id="详细安装步骤">2.2 详细安装步骤</h3>
<p><strong>Windows 系统安装</strong>：下载 Windows 安装包后，直接运行
EXE
文件并按照向导完成安装。安装完成后，需要将安装路径（通常是”bin”文件夹）添加到系统环境变量
PATH
中。具体步骤为：右键”此电脑”→“属性”→“高级系统设置”→“环境变量”，在系统变量中找到
Path，编辑并添加 wkhtmltopdf 的 bin
目录路径。完成设置后，重新打开命令提示符，输入<code>wkhtmltopdf --version</code>验证安装成功。</p>
<p><strong>Linux 系统安装</strong>：对于基于 Debian 的系统（如
Ubuntu），可以使用以下命令安装：</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install wkhtmltopdf</span></code></pre></div>
<p>对于基于 RHEL 的系统（如 CentOS），首先需要安装依赖项：</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install libX11 libXrender libXext libjpeg xorg-x11-fonts-75dpi xorg-x11-fonts-Type1</span></code></pre></div>
<p>然后下载并安装 RPM 包：</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rpm <span class="at">-ivh</span> wkhtmltox-0.12.6-1.centos7.x86_64.rpm</span></code></pre></div>
<p>对于通过 tar 包安装的方式，先下载对应架构的 tar
包，解压后将可执行文件复制到系统路径：</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox-0.12.6-1.centos7.x86_64.rpm</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tar <span class="at">-xvf</span> wkhtmltox-0.12.6-1.centos7.x86_64.rpm</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp wkhtmltox/bin/wkhtmltopdf /usr/bin/</span></code></pre></div>
<p><strong>验证安装</strong>：无论哪种安装方式，安装完成后都应在终端中运行<code>wkhtmltopdf --version</code>命令，确认正确显示版本信息，表明安装成功。</p>
<h3 id="字体配置">2.3 字体配置</h3>
<p>为了确保 PDF 中文字的正确显示，特别是中文字符，需要配置系统字体。在
Linux 系统中，可能需要额外安装中文字体包。对于中文内容，可以将 Windows
系统中的 SimSun、MS YaHei 等中文字体复制到 Linux
系统的<code>/usr/share/fonts/</code>目录下，然后更新字体缓存：</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> fc-cache <span class="at">-fv</span></span></code></pre></div>
<p>在 HTML 文档中，也应确保指定正确的字符编码：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;meta</span> <span class="er">http-equiv</span><span class="ot">=</span><span class="st">&quot;content-type&quot;</span> <span class="er">content</span><span class="ot">=</span><span class="st">&quot;text/html;charset=utf-8&quot;</span> <span class="kw">/&gt;</span></span></code></pre></div>
<p>这样可以避免因编码问题导致的乱码情况。</p>
<h2 id="基础使用与核心功能">3 基础使用与核心功能</h2>
<h3 id="基本命令格式">3.1 基本命令格式</h3>
<p>wkhtmltopdf
的基本命令格式非常直观，主要由工具路径、选项参数、输入源和输出目标组成：</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> <span class="pp">[</span><span class="ss">OPTIONS</span><span class="pp">]</span> <span class="op">&lt;</span>input<span class="op">&gt;</span> <span class="op">&lt;</span>output<span class="op">&gt;</span></span></code></pre></div>
<p>其中，<code>&lt;input&gt;</code> 可以是一个 URL、本地 HTML
文件路径，或者是标准的 HTML
输入（使用<code>-</code>表示从标准输入读取）。<code>&lt;output&gt;</code>
指定生成的 PDF 文件路径。例如，将百度首页转换为 PDF 的基本命令如下：</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> https://www.baidu.com baidu.pdf</span></code></pre></div>
<p>将本地 HTML 文件转换为 PDF 的命令为：</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> example.html example.pdf</span></code></pre></div>
<h3 id="常用命令行参数详解">3.2 常用命令行参数详解</h3>
<p>wkhtmltopdf 提供了丰富的命令行参数，让用户可以精细控制 PDF
输出的各个方面：</p>
<p><strong>页面布局相关参数</strong>：</p>
<ul>
<li><code>--page-size &lt;size&gt;</code>：设置纸张大小，如
A4、A3、Letter 等（默认为 A4）</li>
<li><code>--orientation &lt;Orientation&gt;</code>：设置页面方向，Landscape
为横向，Portrait 为纵向</li>
<li><code>--margin-top &lt;unit&gt;</code>、<code>--margin-bottom &lt;unit&gt;</code>、<code>--margin-left &lt;unit&gt;</code>、<code>--margin-right &lt;unit&gt;</code>：设置页边距，单位可以是
mm、cm、in 等</li>
<li><code>-T &lt;mm&gt;</code>、<code>-B &lt;mm&gt;</code>、<code>-L &lt;mm&gt;</code>、<code>-R &lt;mm&gt;</code>：分别设置上、下、左、右边距的简写形式</li>
</ul>
<p><strong>内容控制参数</strong>：</p>
<ul>
<li><code>--encoding &lt;encoding&gt;</code>：设置输入 HTML
的字符编码（如 utf-8）</li>
<li><code>--disable-external-links</code>：禁止生成指向外部网页的链接</li>
<li><code>--disable-internal-links</code>：禁止生成内部链接（锚点链接）</li>
<li><code>--disable-javascript</code>：禁止页面执行 JavaScript</li>
<li><code>--enable-plugins</code>：启用浏览器插件（如 Flash）</li>
<li><code>--disable-smart-shrinking</code>：禁用 WebKit
的智能缩放功能</li>
<li><code>--zoom &lt;factor&gt;</code>：设置缩放比例（默认 1）</li>
</ul>
<p><strong>页眉页脚参数</strong>： wkhtmltopdf 允许在 PDF
的页眉和页脚添加丰富的内容，包括文本、页码、文档标题等：</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> <span class="at">--header-left</span> <span class="st">&quot;公司报告&quot;</span> <span class="at">--header-center</span> <span class="st">&quot;第[page]页&quot;</span> <span class="at">--header-right</span> <span class="st">&quot;机密文件&quot;</span> <span class="dt">\</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>--footer-center <span class="st">&quot;版权所有 © 2023&quot;</span> https://example.com report.pdf</span></code></pre></div>
<p>在页眉页脚中可以使用以下特殊变量：</p>
<ul>
<li><code>[page]</code>：当前页码</li>
<li><code>[frompage]</code>：起始页码</li>
<li><code>[topage]</code>：结束页码</li>
<li><code>[webpage]</code>：当前页面的 URL</li>
<li><code>[section]</code>：当前章节名称</li>
<li><code>[subsection]</code>：当前子章节名称</li>
<li><code>[date]</code>：当前日期（系统本地格式）</li>
<li><code>[time]</code>：当前时间（系统本地格式）</li>
</ul>
<h3 id="生成目录toc">3.3 生成目录（TOC）</h3>
<p>wkhtmltopdf
强大的目录生成功能可以自动分析文档结构，创建带有层级关系的书签。使用<code>--toc</code>选项可以启用目录生成：</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> <span class="at">--toc</span> http://example.com/long-document document-with-toc.pdf</span></code></pre></div>
<p>目录生成的相关选项非常丰富：</p>
<ul>
<li><code>--toc-depth &lt;level&gt;</code>：设置目录包含的标题层级深度（默认
3 级）</li>
<li><code>--toc-header-text &lt;text&gt;</code>：设置目录页的标题文本</li>
<li><code>--toc-level-indentation &lt;unit&gt;</code>：设置各级目录的缩进量</li>
<li><code>--toc-text-size-shrink &lt;factor&gt;</code>：设置目录文字缩小的比例</li>
<li><code>--toc-l1-font-size &lt;size&gt;</code>：设置一级标题的字体大小</li>
<li><code>--toc-l2-font-size &lt;size&gt;</code>：设置二级标题的字体大小</li>
</ul>
<pre class="mermaid">flowchart TD
    A[开始转换] --&gt; B{是否使用TOC选项?}
    B --&gt;|是| C[分析文档结构]
    B --&gt;|否| D[直接渲染页面]
    C --&gt; E[提取标题层级]
    E --&gt; F[生成目录页面]
    F --&gt; G[将目录插入文档开头]
    G --&gt; H[为每个标题添加锚点]
    H --&gt; I[渲染主要内容]
    D --&gt; I
    I --&gt; J[生成带书签的PDF]
    J --&gt; K[转换完成]</pre>
<h3 id="高级页面控制">3.4 高级页面控制</h3>
<p>对于复杂的文档布局，wkhtmltopdf
提供了封面和封底的支持。可以使用<code>--cover</code>选项指定一个 HTML
文件作为封面，该封面会独立成页，不包含页眉页脚：</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> <span class="at">--cover</span> cover.html toc <span class="at">--toc-header-text</span> <span class="st">&quot;目录&quot;</span> content.html output.pdf</span></code></pre></div>
<p>此外，还可以使用<code>--page-offset</code>选项设置起始页码偏移，这对于将多个文档合并为一个
PDF
时非常有用。<code>--disable-dotted-lines</code>选项可以去除目录中的点线，使外观更加简洁。</p>
<h2 id="高级应用技巧">4 高级应用技巧</h2>
<h3 id="分页控制技巧">4.1 分页控制技巧</h3>
<p>在将长 HTML 文档转换为 PDF 时，合理的分页控制至关重要。wkhtmltopdf
支持通过 CSS 样式控制分页行为，确保内容在合适的位置分页。</p>
<p><strong>强制分页</strong>：在需要分页的 HTML
元素上添加<code>page-break-before: always;</code>或<code>page-break-after: always;</code>样式，可以在该元素前或后强制分页：</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;page-break-after: always;&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 在此元素后分页 --&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;page-break-before: always;&quot;</span><span class="kw">&gt;</span>新章节<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 在此元素前分页 --&gt;</span></span></code></pre></div>
<p><strong>避免内容被分割</strong>：使用<code>page-break-inside: avoid;</code>可以防止元素内容被分割到两页：</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.chapter</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">page-break-inside</span>: <span class="dv">avoid</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>表格分页处理</strong>：对于跨页的长表格，可以通过 CSS
确保表头在每页重复显示：</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>thead {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">display</span>: <span class="dv">table-header-group</span><span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>tbody tr {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">page-break-inside</span>: <span class="dv">avoid</span><span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>需要注意的是，在某些情况下，表格中使用<code>thead</code>标签可能导致分页时出现重复表头的问题。此时，可以考虑使用<code>display: table-header-group;</code>样式来替代。</p>
<h3 id="水印添加技术">4.2 水印添加技术</h3>
<p>为 PDF 添加水印可以通过两种方式实现：在转换前修改 HTML
内容，或在转换后处理 PDF 文件。</p>
<p><strong>转换前添加水印</strong>：通过在 HTML 中添加水印层，利用 CSS
实现水印效果：</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;style&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">.watermark</span> {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">position</span>: <span class="dv">fixed</span><span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">top</span>: <span class="dv">50</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">left</span>: <span class="dv">50</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">transform</span>: <span class="fu">translate(</span><span class="dv">-50</span><span class="dt">%</span><span class="op">,</span> <span class="dv">-50</span><span class="dt">%</span><span class="fu">)</span> <span class="fu">rotate(</span><span class="dv">-45</span><span class="dt">deg</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">font-size</span>: <span class="dv">60</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">color</span>: <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0.1</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">z-index</span>: <span class="dv">9999</span><span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pointer-events</span>: <span class="dv">none</span><span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/style&gt;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;watermark&quot;</span><span class="kw">&gt;</span>机密文件<span class="kw">&lt;/div&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 页面主要内容 --&gt;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p><strong>转换后添加水印（使用
Java+iText）</strong>：通过编程方式为已生成的 PDF
添加水印，这种方法更灵活可靠：</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">setWatermark</span><span class="op">(</span><span class="bu">String</span> input<span class="op">,</span> <span class="bu">String</span> output<span class="op">,</span> <span class="bu">String</span> watermarkText<span class="op">)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">throws</span> DocumentException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    PdfReader reader <span class="op">=</span> <span class="kw">new</span> <span class="fu">PdfReader</span><span class="op">(</span>input<span class="op">);</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    PdfStamper stamper <span class="op">=</span> <span class="kw">new</span> <span class="fu">PdfStamper</span><span class="op">(</span>reader<span class="op">,</span> <span class="kw">new</span> <span class="bu">FileOutputStream</span><span class="op">(</span>output<span class="op">));</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 创建字体</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    BaseFont baseFont <span class="op">=</span> BaseFont<span class="op">.</span><span class="fu">createFont</span><span class="op">(</span><span class="st">&quot;STSong-Light&quot;</span><span class="op">,</span> <span class="st">&quot;UniGB-UCS2-H&quot;</span><span class="op">,</span> BaseFont<span class="op">.</span><span class="fu">EMBEDDED</span><span class="op">);</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 设置水印透明度</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    PdfGState gs <span class="op">=</span> <span class="kw">new</span> <span class="fu">PdfGState</span><span class="op">();</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    gs<span class="op">.</span><span class="fu">setFillOpacity</span><span class="op">(</span><span class="fl">0.2f</span><span class="op">);</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> totalPages <span class="op">=</span> reader<span class="op">.</span><span class="fu">getNumberOfPages</span><span class="op">();</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> totalPages<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取页面尺寸</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Rectangle</span> pageSize <span class="op">=</span> reader<span class="op">.</span><span class="fu">getPageSize</span><span class="op">(</span>i<span class="op">);</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> width <span class="op">=</span> pageSize<span class="op">.</span><span class="fu">getWidth</span><span class="op">();</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> height <span class="op">=</span> pageSize<span class="op">.</span><span class="fu">getHeight</span><span class="op">();</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取水印层</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        PdfContentByte content <span class="op">=</span> stamper<span class="op">.</span><span class="fu">getOverContent</span><span class="op">(</span>i<span class="op">);</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">saveState</span><span class="op">();</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">setGState</span><span class="op">(</span>gs<span class="op">);</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">beginText</span><span class="op">();</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">setFontAndSize</span><span class="op">(</span>baseFont<span class="op">,</span> <span class="dv">50</span><span class="op">);</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">setColorFill</span><span class="op">(</span><span class="bu">Color</span><span class="op">.</span><span class="fu">GRAY</span><span class="op">);</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 计算水印位置（居中）</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> x <span class="op">=</span> width <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> y <span class="op">=</span> height <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">showTextAligned</span><span class="op">(</span><span class="bu">Element</span><span class="op">.</span><span class="fu">ALIGN_CENTER</span><span class="op">,</span> watermarkText<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> <span class="dv">45</span><span class="op">);</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">endText</span><span class="op">();</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">restoreState</span><span class="op">();</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    stamper<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    reader<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对于中文水印，在 Linux
环境下可能会遇到字体识别问题。解决方案是使用图片水印替代文字水印，或者确保系统中已安装正确的中文字体。</p>
<h3 id="多文件合并与批量处理">4.3 多文件合并与批量处理</h3>
<p>wkhtmltopdf 天然支持将多个输入源合并为一个 PDF
文件。只需在命令中依次列出所有输入文件和最终的输出文件即可：</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> cover.html toc content1.html content2.html content3.html appendix.html full-document.pdf</span></code></pre></div>
<p>对于批量转换大量 HTML 文件，可以结合 Shell 脚本或 PowerShell
实现自动化处理：</p>
<p><strong>Linux Shell 脚本示例</strong>：</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="va">OUTPUT_DIR</span><span class="op">=</span><span class="st">&quot;./pdf_output&quot;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">$OUTPUT_DIR</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file <span class="kw">in</span> <span class="pp">*</span>.html<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">filename</span><span class="op">=</span><span class="va">$(</span><span class="fu">basename</span> <span class="st">&quot;</span><span class="va">$file</span><span class="st">&quot;</span> .html<span class="va">)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">wkhtmltopdf</span> <span class="at">--encoding</span> utf-8 <span class="st">&quot;</span><span class="va">$file</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$OUTPUT_DIR</span><span class="st">/</span><span class="va">$filename</span><span class="st">.pdf&quot;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;批量转换完成&quot;</span></span></code></pre></div>
<p><strong>Windows PowerShell 脚本示例</strong>：</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Get-ChildItem</span> <span class="op">*.</span><span class="fu">html</span> <span class="op">|</span> <span class="fu">ForEach-Object</span> <span class="op">-</span>Process <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$newname</span> <span class="op">=</span> <span class="op">(</span><span class="va">$_</span><span class="op">.</span><span class="fu">name</span><span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="st">&quot;.&quot;</span><span class="op">)[</span>0<span class="op">]</span> <span class="op">+</span> <span class="st">&#39;.pdf&#39;</span><span class="op">)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    wkhtmltopdf <span class="op">--</span>encoding utf8 <span class="va">$_</span><span class="op">.</span><span class="fu">name</span> <span class="va">$newname</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对于更复杂的合并需求，如需要动态调整页面顺序或添加分隔页，可以先用
wkhtmltopdf 生成各个部分的 PDF，再使用 PDF 处理库（如
iText、PyPDF2）进行精细合并。</p>
<h2 id="编程语言集成">5 编程语言集成</h2>
<h3 id="java-集成示例">5.1 Java 集成示例</h3>
<p>在 Java 应用中集成
wkhtmltopdf，可以通过<code>Runtime.getRuntime().exec()</code>方法执行命令行转换。以下是完整的工具类示例：</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WkHtmlToPdfUtil <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> HTML<span class="co">转</span>PDF</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param srcPath <span class="co">输入</span>HTML<span class="co">路径（</span>URL<span class="co">或文件路径）</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>param destPath <span class="co">输出</span>PDF<span class="co">路径</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return <span class="co">转换是否成功</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">boolean</span> <span class="fu">convert</span><span class="op">(</span><span class="bu">String</span> srcPath<span class="op">,</span> <span class="bu">String</span> destPath<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">StringBuilder</span> cmd <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 根据操作系统选择执行路径</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">getProperty</span><span class="op">(</span><span class="st">&quot;os.name&quot;</span><span class="op">).</span><span class="fu">contains</span><span class="op">(</span><span class="st">&quot;Windows&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>            cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;C:</span><span class="sc">\\</span><span class="st">Program Files</span><span class="sc">\\</span><span class="st">wkhtmltopdf</span><span class="sc">\\</span><span class="st">bin</span><span class="sc">\\</span><span class="st">wkhtmltopdf.exe&quot;</span><span class="op">);</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>            cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;/usr/local/bin/wkhtmltopdf&quot;</span><span class="op">);</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 添加常用参数</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --page-size A4&quot;</span><span class="op">);</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --margin-top 15mm&quot;</span><span class="op">);</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --margin-bottom 15mm&quot;</span><span class="op">);</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --margin-left 10mm&quot;</span><span class="op">);</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --margin-right 10mm&quot;</span><span class="op">);</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; --encoding UTF-8&quot;</span><span class="op">);</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        cmd<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>srcPath<span class="op">).</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">).</span><span class="fu">append</span><span class="op">(</span>destPath<span class="op">);</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Process</span> process <span class="op">=</span> <span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">exec</span><span class="op">(</span>cmd<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 处理输出流，避免阻塞</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>            StreamGobbler errorGobbler <span class="op">=</span> <span class="kw">new</span> <span class="fu">StreamGobbler</span><span class="op">(</span>process<span class="op">.</span><span class="fu">getErrorStream</span><span class="op">(),</span> <span class="st">&quot;ERROR&quot;</span><span class="op">);</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            StreamGobbler outputGobbler <span class="op">=</span> <span class="kw">new</span> <span class="fu">StreamGobbler</span><span class="op">(</span>process<span class="op">.</span><span class="fu">getInputStream</span><span class="op">(),</span> <span class="st">&quot;OUTPUT&quot;</span><span class="op">);</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            errorGobbler<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>            outputGobbler<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> exitCode <span class="op">=</span> process<span class="op">.</span><span class="fu">waitFor</span><span class="op">();</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> exitCode <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">处理进程输出流的内部类</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="kw">class</span> StreamGobbler <span class="kw">extends</span> <span class="bu">Thread</span> <span class="op">{</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">InputStream</span> is<span class="op">;</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> type<span class="op">;</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">StreamGobbler</span><span class="op">(</span><span class="bu">InputStream</span> is<span class="op">,</span> <span class="bu">String</span> type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">is</span> <span class="op">=</span> is<span class="op">;</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">type</span> <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">(</span><span class="bu">InputStreamReader</span> isr <span class="op">=</span> <span class="kw">new</span> <span class="bu">InputStreamReader</span><span class="op">(</span>is<span class="op">);</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>                 <span class="bu">BufferedReader</span> br <span class="op">=</span> <span class="kw">new</span> <span class="bu">BufferedReader</span><span class="op">(</span>isr<span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> line<span class="op">;</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">((</span>line <span class="op">=</span> br<span class="op">.</span><span class="fu">readLine</span><span class="op">())</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>type <span class="op">+</span> <span class="st">&quot;&gt; &quot;</span> <span class="op">+</span> line<span class="op">);</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>解决进程阻塞问题</strong>：在使用 Java 调用 wkhtmltopdf
时，常见的问题是进程阻塞导致无法完成转换。这是因为进程的输出流和错误流没有被及时处理。解决方案是使用单独的线程处理这些流，如上述代码所示。</p>
<h3 id="python-集成示例">5.2 Python 集成示例</h3>
<p>Python 可以通过<code>pdfkit</code>库（wkhtmltopdf
的包装器）或<code>subprocess</code>模块调用 wkhtmltopdf。</p>
<p><strong>使用 pdfkit 库</strong>：</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pdfkit</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 配置wkhtmltopdf路径</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> pdfkit.configuration(wkhtmltopdf<span class="op">=</span><span class="st">&#39;/usr/local/bin/wkhtmltopdf&#39;</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 基本转换</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>pdfkit.from_url(<span class="st">&#39;http://example.com&#39;</span>, <span class="st">&#39;output.pdf&#39;</span>, configuration<span class="op">=</span>config)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用选项转换</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>options <span class="op">=</span> {</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;page-size&#39;</span>: <span class="st">&#39;A4&#39;</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;margin-top&#39;</span>: <span class="st">&#39;0.75in&#39;</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;margin-right&#39;</span>: <span class="st">&#39;0.75in&#39;</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;margin-bottom&#39;</span>: <span class="st">&#39;0.75in&#39;</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;margin-left&#39;</span>: <span class="st">&#39;0.75in&#39;</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;encoding&#39;</span>: <span class="st">&quot;UTF-8&quot;</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;header-center&#39;</span>: <span class="st">&#39;报表标题&#39;</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;footer-center&#39;</span>: <span class="st">&#39;第[page]页/共[topage]页&#39;</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>pdfkit.from_file(<span class="st">&#39;input.html&#39;</span>, <span class="st">&#39;output.pdf&#39;</span>, options<span class="op">=</span>options, configuration<span class="op">=</span>config)</span></code></pre></div>
<p><strong>使用 subprocess 模块</strong>：</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_pdf(source_html, output_pdf):</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 构建命令</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    cmd <span class="op">=</span> [<span class="st">&#39;wkhtmltopdf&#39;</span>, <span class="st">&#39;--encoding&#39;</span>, <span class="st">&#39;utf-8&#39;</span>, <span class="st">&#39;--quality&#39;</span>, <span class="st">&#39;100&#39;</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 添加选项</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    cmd.extend([<span class="st">&#39;--margin-top&#39;</span>, <span class="st">&#39;15mm&#39;</span>])</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    cmd.extend([<span class="st">&#39;--margin-bottom&#39;</span>, <span class="st">&#39;15mm&#39;</span>])</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    cmd.extend([<span class="st">&#39;--margin-left&#39;</span>, <span class="st">&#39;10mm&#39;</span>])</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    cmd.extend([<span class="st">&#39;--margin-right&#39;</span>, <span class="st">&#39;10mm&#39;</span>])</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    cmd.append(source_html)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    cmd.append(output_pdf)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 执行转换</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> subprocess.run(cmd, capture_output<span class="op">=</span><span class="va">True</span>, text<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;转换成功&quot;</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;转换失败: </span><span class="sc">{</span>e<span class="sc">.</span>stderr<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用示例</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>html_to_pdf(<span class="st">&#39;input.html&#39;</span>, <span class="st">&#39;output.pdf&#39;</span>)</span></code></pre></div>
<h3 id="c集成示例">5.3 C#集成示例</h3>
<p>在 C#应用中，可以通过<code>Process</code>类调用 wkhtmltopdf：</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Diagnostics</span><span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">IO</span><span class="op">;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PdfGenerator</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">bool</span> <span class="fu">GeneratePdf</span><span class="op">(</span><span class="dt">string</span> htmlPath<span class="op">,</span> <span class="dt">string</span> pdfPath<span class="op">)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 验证输入文件是否存在</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>File<span class="op">.</span><span class="fu">Exists</span><span class="op">(</span>htmlPath<span class="op">))</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">FileNotFoundException</span><span class="op">(</span><span class="st">&quot;HTML文件不存在&quot;</span><span class="op">,</span> htmlPath<span class="op">);</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 创建输出目录</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> outputDir <span class="op">=</span> Path<span class="op">.</span><span class="fu">GetDirectoryName</span><span class="op">(</span>pdfPath<span class="op">);</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>Directory<span class="op">.</span><span class="fu">Exists</span><span class="op">(</span>outputDir<span class="op">))</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            Directory<span class="op">.</span><span class="fu">CreateDirectory</span><span class="op">(</span>outputDir<span class="op">);</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 构建命令参数</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> parameters <span class="op">=</span> $@<span class="st">&quot;--page-size A4 --margin-top 15 --margin-bottom 15 --margin-left 10 --margin-right 10 --encoding UTF-8 &quot;&quot;{htmlPath}&quot;&quot; &quot;&quot;{pdfPath}&quot;&quot;&quot;</span><span class="op">;</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        ProcessStartInfo startInfo <span class="op">=</span> <span class="kw">new</span> ProcessStartInfo</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            FileName <span class="op">=</span> <span class="st">&quot;wkhtmltopdf.exe&quot;</span><span class="op">,</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>            Arguments <span class="op">=</span> parameters<span class="op">,</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>            UseShellExecute <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>            CreateNoWindow <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            RedirectStandardOutput <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            RedirectStandardError <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">try</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">using</span> <span class="op">(</span>Process process <span class="op">=</span> Process<span class="op">.</span><span class="fu">Start</span><span class="op">(</span>startInfo<span class="op">))</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 读取输出流</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>                <span class="dt">string</span> output <span class="op">=</span> process<span class="op">.</span><span class="fu">StandardOutput</span><span class="op">.</span><span class="fu">ReadToEnd</span><span class="op">();</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>                <span class="dt">string</span> errors <span class="op">=</span> process<span class="op">.</span><span class="fu">StandardError</span><span class="op">.</span><span class="fu">ReadToEnd</span><span class="op">();</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>                process<span class="op">.</span><span class="fu">WaitForExit</span><span class="op">();</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">(</span>process<span class="op">.</span><span class="fu">ExitCode</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>                    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span>$<span class="st">&quot;错误: {errors}&quot;</span><span class="op">);</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>                Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;PDF生成成功&quot;</span><span class="op">);</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">catch</span> <span class="op">(</span>Exception ex<span class="op">)</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>            Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span>$<span class="st">&quot;异常: {ex.Message}&quot;</span><span class="op">);</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="常见问题与解决方案">6 常见问题与解决方案</h2>
<h3 id="中文乱码问题">6.1 中文乱码问题</h3>
<p>中文乱码是 wkhtmltopdf
使用中最常见的问题之一，主要由字体缺失或编码设置不正确引起。</p>
<p><strong>解决方案</strong>：</p>
<ol type="1">
<li><strong>确保 HTML 文档指定正确的编码</strong>：</li>
</ol>
<div class="sourceCode" id="cb26"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;meta</span> <span class="er">http-equiv</span><span class="ot">=</span><span class="st">&quot;Content-Type&quot;</span> <span class="er">content</span><span class="ot">=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span> <span class="kw">/&gt;</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>在命令行中明确指定编码</strong>：</li>
</ol>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">wkhtmltopdf</span> <span class="at">--encoding</span> UTF-8 input.html output.pdf</span></code></pre></div>
<ol start="3" type="1">
<li><p><strong>安装中文字体</strong>：</p>
<ul>
<li><strong>Windows</strong>：确保系统已安装所需的中文字体</li>
<li><strong>Linux</strong>：将中文字体文件复制到<code>/usr/share/fonts/</code>目录，然后更新字体缓存：</li>
</ul>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp simsun.ttf /usr/share/fonts/</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> fc-cache <span class="at">-fv</span></span></code></pre></div></li>
<li><p><strong>在 CSS 中指定字体族</strong>：</p></li>
</ol>
<div class="sourceCode" id="cb29"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>body {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">font-family</span>: <span class="st">&quot;SimSun&quot;</span><span class="op">,</span> <span class="st">&quot;Microsoft YaHei&quot;</span><span class="op">,</span> <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="样式和脚本支持限制">6.2 样式和脚本支持限制</h3>
<p>wkhtmltopdf 基于较旧的 WebKit 引擎，对现代 CSS3 和
ES6+特性支持有限。</p>
<p><strong>不支持的 CSS 特性</strong>：</p>
<ul>
<li><code>display: flex</code>（Flexbox 布局）</li>
<li><code>display: grid</code>（Grid 布局）</li>
<li>CSS Transforms（<code>transform</code>属性）</li>
<li>CSS Transitions（过渡动画）</li>
<li>CSS Animations（关键帧动画）</li>
<li><code>position: sticky</code>（粘性定位）</li>
</ul>
<p><strong>不支持的 JavaScript 特性</strong>：</p>
<ul>
<li>ES6+语法（箭头函数、let/const、模板字符串等）</li>
<li>现代浏览器 API（Fetch、Promise 等）</li>
<li>部分数组方法（如<code>includes</code>、<code>forEach</code>在某些版本中可能有问题）</li>
</ul>
<p><strong>兼容性解决方案</strong>：</p>
<ol type="1">
<li><strong>使用传统的 CSS 布局</strong>：优先使用 float、inline-block
和传统盒模型</li>
<li><strong>降级 JavaScript 代码</strong>：使用 Babel 等工具将
ES6+代码转译为 ES5</li>
<li><strong>避免现代 API</strong>：使用 XMLHttpRequest 替代
Fetch，回调函数替代 Promise</li>
<li><strong>全面测试</strong>：在实际使用前充分测试所有功能</li>
</ol>
<h3 id="性能优化与故障排除">6.3 性能优化与故障排除</h3>
<p><strong>性能优化建议</strong>：</p>
<ol type="1">
<li><strong>减少外部资源</strong>：尽量减少页面中的外部资源（图片、CSS、JS）数量</li>
<li><strong>使用本地资源</strong>：将外部资源下载到本地，使用相对路径引用</li>
<li><strong>设置超时时间</strong>：使用<code>--javascript-delay</code>参数给
JS 执行留出足够时间</li>
<li><strong>禁用不必要的功能</strong>：如不需要
JS，使用<code>--disable-javascript</code>提升性能</li>
</ol>
<p><strong>常见错误及解决</strong>：</p>
<ol type="1">
<li><strong>进程挂起/阻塞</strong>：确保正确处理标准输出和错误流</li>
<li><strong>内存不足</strong>：对于大文档，适当增加 JVM
内存或使用分块处理</li>
<li><strong>权限问题</strong>：确保 wkhtmltopdf
有足够的文件系统访问权限</li>
<li><strong>路径问题</strong>：使用绝对路径而非相对路径，避免路径解析错误</li>
</ol>
<p><strong>调试技巧</strong>：</p>
<ol type="1">
<li><strong>启用详细日志</strong>：添加<code>--debug</code>参数获取详细输出</li>
<li><strong>分阶段测试</strong>：先测试简单 HTML，逐步增加复杂度</li>
<li><strong>使用浏览器验证</strong>：先用 Chrome 浏览器查看 HTML
显示是否正常</li>
<li><strong>检查控制台错误</strong>：通过开发者工具检查浏览器控制台是否有
JS 错误</li>
</ol>
<h2 id="总结">7 总结</h2>
<p>wkhtmltopdf 作为一个基于 WebKit 引擎的 HTML 转 PDF
工具，在保真度和兼容性方面表现出色，特别适合需要高精度还原 Web
页面样式的场景。通过本文介绍的安装配置、基础使用、高级技巧和编程集成方法，读者应能全面掌握这一强大工具的应用。</p>
<p>虽然 wkhtmltopdf 对最新 Web
标准的支持存在一定局限，且项目活跃度有所降低，但在许多传统业务场景中，它仍然是生成高质量
PDF
的首选方案。通过合理的兼容性处理和故障排除，可以解决大部分使用中遇到的问题。</p>
<p>对于需要更高性能或更现代标准支持的项目，可以考虑像
Puppeteer、Playwright 这样的无头浏览器方案，但 wkhtmltopdf
在简单性、资源消耗和部署便利性方面仍具有明显优势，值得在合适的项目中采用。</p>
<h3 id="延伸阅读">延伸阅读</h3>
<ul>
<li>官方文档：http://wkhtmltopdf.org/usage/wkhtmltopdf.txt</li>
<li>项目源码：https://github.com/wkhtmltopdf/wkhtmltopdf</li>
<li>完整选项说明：https://wkhtmltopdf.org/usage/wkhtmltopdf.txt</li>
</ul>
<h3 id="一句话记忆">一句话记忆</h3>
<p>wkhtmltopdf 通过 WebKit 引擎将 HTML 精准转换为 PDF，虽对现代 Web
标准支持有限，但通过合理配置和兼容性处理，仍是高质量 PDF
生成的可靠选择。 帮我再优化或者再深入一些</p>
</div>
    </article>
  </div>
  <aside class="toc-sidebar" id="toc-sidebar">
    <div class="toc-header">
      <h3>文章目录</h3>
    </div>
    <nav class="toc-nav" id="toc-nav">
      <!-- 目录内容将通过JavaScript自动生成 -->
    </nav>
  </aside>
</div>

<script>
  // Add copy buttons to code blocks
  function addCopyButtons() {
    const sourceCodeBlocks = document.querySelectorAll(".sourceCode");
    sourceCodeBlocks.forEach(function (block) {
      if (block.querySelector(".copy-button")) return;
      const preElement = block.querySelector("pre");
      if (!preElement) return;

      const button = document.createElement("button");
      button.className = "copy-button";
      button.textContent = "复制";
      button.setAttribute("aria-label", "复制代码");

      button.addEventListener("click", function () {
        const code = preElement.querySelector("code");
        const text = code ? code.innerText : preElement.innerText;

        navigator.clipboard
          .writeText(text)
          .then(function () {
            button.textContent = "已复制";
            button.classList.add("copied");

            setTimeout(function () {
              button.textContent = "复制";
              button.classList.remove("copied");
            }, 3000);
          })
          .catch(function (err) {
            console.error("复制失败: ", err);
            button.textContent = "失败";
            setTimeout(function () {
              button.textContent = "复制";
            }, 3000);
          });
      });

      block.appendChild(button);
    });

    const allPreBlocks = document.querySelectorAll("pre:not(.mermaid)");
    allPreBlocks.forEach(function (block) {
      if (block.closest(".sourceCode") || block.querySelector(".copy-button"))
        return;

      const button = document.createElement("button");
      button.className = "copy-button";
      button.textContent = "复制";
      button.setAttribute("aria-label", "复制代码");

      button.addEventListener("click", function () {
        const code = block.querySelector("code");
        const text = code ? code.innerText : block.innerText;

        navigator.clipboard
          .writeText(text)
          .then(function () {
            button.textContent = "已复制";
            button.classList.add("copied");

            setTimeout(function () {
              button.textContent = "复制";
              button.classList.remove("copied");
            }, 3000);
          })
          .catch(function (err) {
            console.error("复制失败: ", err);
            button.textContent = "失败";
            setTimeout(function () {
              button.textContent = "复制";
            }, 3000);
          });
      });

      block.appendChild(button);
    });
  }

  // 生成文章目录
  function generateTableOfContents() {
    const postContent = document.getElementById("post-content");
    const tocNav = document.getElementById("toc-nav");

    if (!postContent || !tocNav) {
      console.log("Missing postContent or tocNav element");
      return;
    }

    // 查找所有标题元素
    const headings = postContent.querySelectorAll("h1, h2, h3, h4, h5, h6");
    console.log("Found headings:", headings.length);

    if (headings.length === 0) {
      // 如果没有标题，隐藏目录
      console.log("No headings found, hiding TOC");
      const tocSidebar = document.getElementById("toc-sidebar");
      if (tocSidebar) tocSidebar.style.display = "none";
      return;
    }

    // 清空目录容器
    tocNav.innerHTML = "";

    // 创建目录结构
    const tocList = document.createElement("ul");
    tocList.className = "toc-list";

    let currentLevel = 1;
    let currentList = tocList;
    let listStack = [tocList];

    headings.forEach((heading, index) => {
      // 强制为每个标题设置标准化的ID（始终重写现有ID）
      const normalizedId = "heading-" + index;
      heading.id = normalizedId;

      const level = parseInt(heading.tagName.charAt(1));
      const title = heading.textContent.trim();

      // 创建目录项
      const tocItem = document.createElement("li");
      tocItem.className = "toc-item toc-level-" + level;

      const tocLink = document.createElement("a");
      tocLink.href = "javascript:void(0)"; // 避免触发路由
      tocLink.setAttribute("data-target", heading.id); // 存储目标ID
      tocLink.textContent = title;
      tocLink.className = "toc-link";

      tocItem.appendChild(tocLink);

      // 处理层级关系
      if (level > currentLevel) {
        // 创建新的子列表
        const newList = document.createElement("ul");
        newList.className = "toc-sublist";
        // 检查是否有父元素
        const parentList = listStack[listStack.length - 1];
        if (parentList.lastElementChild) {
          parentList.lastElementChild.appendChild(newList);
        } else {
          // 如果没有父元素，直接添加到当前列表
          parentList.appendChild(newList);
        }
        listStack.push(newList);
        currentList = newList;
      } else if (level < currentLevel) {
        // 返回到上一级
        while (listStack.length > level) {
          listStack.pop();
        }
        currentList = listStack[listStack.length - 1];
      }

      currentList.appendChild(tocItem);
      currentLevel = level;
    });

    tocNav.appendChild(tocList);
    console.log("TOC generated successfully");

    // 高亮当前章节
    highlightCurrentSection();

    // 滚动监听
    window.addEventListener("scroll", highlightCurrentSection);

    // 为目录链接添加点击事件
    setTimeout(() => {
      const tocLinks = document.querySelectorAll(".toc-link");
      tocLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const targetId = link.getAttribute("data-target");
          if (targetId) {
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({
                behavior: "smooth",
                block: "start",
                inline: "nearest",
              });
            }
          }
        });
      });
    }, 200); // 延迟确保目录已生成
  }

  // 高亮当前阅读的章节
  function highlightCurrentSection() {
    const headings = document.querySelectorAll(
      ".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6"
    );
    const tocLinks = document.querySelectorAll(".toc-link");

    let currentHeading = null;
    const scrollPosition = window.pageYOffset + 100;

    // 找到当前可见的标题
    for (let i = headings.length - 1; i >= 0; i--) {
      if (headings[i].offsetTop <= scrollPosition) {
        currentHeading = headings[i];
        break;
      }
    }

    // 清除所有活动状态
    tocLinks.forEach((link) => link.classList.remove("active"));

    // 高亮当前章节
    if (currentHeading) {
      const activeLink = document.querySelector(
        '.toc-link[data-target="' + currentHeading.id + '"]'
      );
      if (activeLink) {
        activeLink.classList.add("active");
      }
    }
  }

  // Initialize mermaid diagrams - 只在直接访问 fragment 时运行
  async function initMermaid() {
    // 检查是否在 SPA 环境中
    if (window.IN_SPA_MODE === true) {
      console.log(
        "[Mermaid Fragment] In SPA mode, skipping fragment initialization"
      );
      return;
    }

    if (typeof mermaid === "undefined") {
      console.log("[Mermaid Fragment] Library not loaded");
      return;
    }

    const mermaidPreElements = document.querySelectorAll(
      "pre.mermaid, div.mermaid"
    );
    if (mermaidPreElements.length === 0) {
      console.log("[Mermaid Fragment] No diagrams found");
      return;
    }

    console.log(
      "[Mermaid Fragment] 找到",
      mermaidPreElements.length,
      "个 Mermaid 图表，准备渲染..."
    );

    // 处理 DOM 结构
    const elementsToRun = [];

    mermaidPreElements.forEach((element) => {
      // 获取原始图表代码
      const graphDefinition = element.textContent.trim();
      console.log(
        "[Mermaid Fragment] First 100 chars:",
        graphDefinition.substring(0, 100)
      );

      // 创建一个新的 div 来替换旧的 pre/div，确保它是"干净"的
      const newDiv = document.createElement("div");
      newDiv.className = "mermaid";
      newDiv.textContent = graphDefinition;
      newDiv.setAttribute("data-mermaid-code", graphDefinition);

      element.parentNode.replaceChild(newDiv, element);
      elementsToRun.push(newDiv);
    });

    // 手动触发渲染
    try {
      await mermaid.run({
        nodes: elementsToRun,
      });
      console.log("[Mermaid Fragment] 渲染完成");
    } catch (err) {
      console.error("[Mermaid Fragment] 渲染失败:", err);
      // 出错时显示原始代码，避免白屏
      elementsToRun.forEach((el) => {
        el.style.whiteSpace = "pre";
        el.style.border = "1px solid red";
      });
    }
  }

  // Initialize copy buttons and TOC after content loads
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      console.log("DOM loading, initializing...");
      addCopyButtons();
      setTimeout(generateTableOfContents, 100);
      setTimeout(initMermaid, 200);
    });
  } else {
    console.log("DOM already loaded, initializing...");
    addCopyButtons();
    setTimeout(generateTableOfContents, 100);
    setTimeout(initMermaid, 200);
  }
</script>
