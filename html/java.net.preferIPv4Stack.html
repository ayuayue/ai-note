<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Feign / IDEA IPv4 解决方案与双栈套接字动画讲解</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#4f9cff; --muted:#98a0b3; --good:#37d67a;
    --danger:#ff6b6b;
  }
  body{font-family:Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:linear-gradient(180deg,#071025 0%, #07182a 100%); color:#e6eef8;}
  .wrap{max-width:980px;margin:36px auto;padding:24px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:12px; box-shadow:0 10px 30px rgba(3,10,25,0.6);}
  h1{margin:0 0 8px;font-weight:700}
  p.lead{color:var(--muted);margin-top:0}
  .row{display:flex;gap:18px;align-items:flex-start}
  .col{flex:1;min-width:0}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px;padding:14px;box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 0 6px 20px rgba(2,6,15,0.6);}
  .small{font-size:13px;color:var(--muted)}
  .kbd{background:#081425;padding:4px 8px;border-radius:6px;font-weight:600;border:1px solid rgba(255,255,255,0.03)}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;background:var(--accent);color:#031126;font-weight:700;cursor:pointer;border:none;}
  .status{display:inline-block;padding:6px 10px;border-radius:8px;background:#061322;color:var(--muted);font-weight:600;border:1px solid rgba(255,255,255,0.03)}
  /* network diagram */
  .diagram{height:300px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
  .lane{position:relative;width:85%;height:48px;border-radius:24px;margin:14px 0;display:flex;align-items:center;padding:8px 16px;box-sizing:border-box;}
  .lane-label{width:110px;font-size:13px;color:var(--muted);margin-right:12px}
  .lane.v4{background:linear-gradient(90deg,#061a0f,#082219); border:1px solid rgba(255,255,255,0.03)}
  .lane.v6{background:linear-gradient(90deg,#0a1130,#07102a); border:1px solid rgba(255,255,255,0.03)}
  .jvm{position:absolute;left:6%;top:45%;transform:translateY(-50%);width:130px;height:84px;border-radius:10px;background:#06112a;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;justify-content:center;align-items:center;box-shadow:0 8px 30px rgba(2,8,20,0.6)}
  .jvm strong{color:var(--accent)}
  .server{position:absolute;right:6%;top:45%;transform:translateY(-50%);width:140px;height:100px;border-radius:10px;background:#071026;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;justify-content:center;align-items:center}
  .packet{position:absolute;width:22px;height:14px;border-radius:6px;font-size:11px;display:flex;align-items:center;justify-content:center;color:#041124;font-weight:700}
  .pkt-v4{background:linear-gradient(90deg,#7ad29f,#37d67a)}
  .pkt-v6{background:linear-gradient(90deg,#7fb6ff,#4f9cff)}
  /* animation controls */
  .controls{display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap}
  .note{font-size:13px;color:var(--muted);margin-top:12px}
  /* movement animation (JS-driven via classes) */
  .moving{transition: transform 1.6s cubic-bezier(.2,.9,.3,1)}
  /* explanation list */
  ol.explain{padding-left:18px;color:var(--muted)}
  li{margin:8px 0}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  /* responsive */
  @media (max-width:820px){ .row{flex-direction:column} .diagram{height:360px} .jvm{left:6%;top:30%} .server{right:6%;top:70%}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Feign 在 IDEA 下被拦截问题 & 双栈套接字（Dual-Stack Socket）动画讲解</h1>
  <p class="lead">问题复盘、为什么会发生、以及你为何通过 `-Djava.net.preferIPv4Stack=true` 解决（交互动画演示）</p>

  <div class="row" style="margin-top:14px">
    <div class="col">
      <div class="card">
        <h3 style="margin:0 0 6px">问题概述</h3>
        <p class="small">你使用 EasyConnect VPN 后在 IntelliJ IDEA 内发起的 **HTTP（Feign）调用** 被接口拦截（或失败），但使用 Postman / curl / 其他工具时能正常访问。你通过在 IDEA 的 JVM 参数添加：<span class="kbd">-Djava.net.preferIPv4Stack=true</span> 后问题解决。</p>
        <div class="note"><strong>结论（快速）：</strong>问题来源于 JVM 默认使用 IPv6/双栈行为，与 VPN 的路由或代理不兼容；强制使用 IPv4 绕过了该不兼容。 </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 6px">核心概念：什么是 <em>双栈套接字</em>？</h3>
        <ol class="explain">
          <li>双栈设备/主机同时支持 IPv4 和 IPv6 协议。:contentReference[oaicite:1]{index=1}</li>
          <li>在许多系统上（含 Java 的网络实现），JVM 会创建一个 <strong>IPv6 套接字</strong> 并允许通过“映射的 IPv4 地址（IPv4-mapped IPv6）” 来和 IPv4 主机通信——这就是“dual-stack socket”的典型行为。:contentReference[oaicite:2]{index=2}</li>
          <li>优点：只需一个监听 socket 就可同时接收 IPv4 与 IPv6 连接（某些平台需设置 `IPV6_V6ONLY`）。缺点：不同平台上的行为不完全一致，且在某些 VPN/代理下会出现路由或兼容性问题。:contentReference[oaicite:3]{index=3}</li>
        </ol>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3 style="margin:0 0 6px">动画演示（点击按钮触发）</h3>
        <div class="diagram" id="diagram">
          <div class="jvm">
            <div style="font-size:13px;color:var(--muted)">IDEA JVM</div>
            <strong>Feign 请求</strong>
          </div>
          <div class="server">
            <div style="font-size:13px;color:var(--muted)">远端 API</div>
            <div style="font-size:13px;margin-top:6px">（支持 IPv4/IPv6）</div>
          </div>

          <!-- lanes -->
          <div style="position:absolute;left:20%;right:20%;top:30%;display:flex;align-items:center;">
            <div class="lane v4" style="width:100%;"><div class="lane-label">IPv4 通道</div></div>
          </div>
          <div style="position:absolute;left:20%;right:20%;top:58%;display:flex;align-items:center;">
            <div class="lane v6" style="width:100%;"><div class="lane-label">IPv6 / Dual-stack 通道</div></div>
          </div>

          <!-- packets (start near JVM) -->
          <div id="pkt1" class="packet pkt-v6" style="left:14%; top:45%; transform:translateY(-50%);">6</div>
          <div id="pkt2" class="packet pkt-v4" style="left:14%; top:35%; transform:translateY(-50%);">4</div>

        </div>

        <div class="controls">
          <button class="btn" id="btnSend">发送示例请求</button>
          <button class="btn" id="btnToggle" style="background:#ffb86b;color:#031126">切换：强制 IPv4 OFF</button>
          <div style="margin-left:auto" class="status" id="status">当前：JVM 优先双栈（IPv6 可见）</div>
        </div>

        <p class="note">演示说明：点击 <strong>发送示例请求</strong>，两条“数据包”会尝试通过各自通道到达服务端。切换按钮模拟 JVM 是否强制只用 IPv4。</p>
      </div>
    </div>
  </div>

  <div style="margin-top:14px" class="card">
    <h3 style="margin:0 0 6px">问题原因简要与建议步骤</h3>
    <ol class="explain">
      <li>IDEA（即 JVM）默认可能优先使用 IPv6 / dual-stack 套接字；在某些 VPN（如 EasyConnect）的网络策略/代理下，IPv6 路径或 IPv4-mapped 转换会被错误处理或拦截，导致 Feign 请求失败。:contentReference[oaicite:4]{index=4}</li>
      <li>将 JVM 启动参数添加：<span class="kbd">-Djava.net.preferIPv4Stack=true</span> 可强制 JVM 仅使用 IPv4 套接字，避免双栈带来的兼容问题（你用这个方式已解决）。:contentReference[oaicite:5]{index=5}</li>
      <li>其他可选项：在 IDEA 中检查 HTTP Proxy 设置、在 Feign 中打印并比对请求头/目标 IP，或尝试替换 HTTP 客户端（例如用 WebClient）来进一步排查。 </li>
    </ol>
    <div style="margin-top:10px" class="small">如果需要，我可以把这份 HTML 进一步改成自带「导出 PDF」或「演示模式（全屏）」的版本。</div>
  </div>

  <footer>
    <div>来源 / 参考（关键说明）：</div>
    <ul class="small">
      <li>Oracle Java 网络属性（说明 java.net.preferIPv4Stack 的作用）。</li>
      <li>Java IPv6 指南（解释 dual-stack 与 IPv4-mapped IPv6 地址的行为）。</li>
      <li>Microsoft 文档：dual-stack sockets 能够通过一个 IPv6 socket 处理 IPv4 和 IPv6。 </li>
    </ul>
  </footer>
</div>

<script>
  // 控制变量
  let forceIPv4 = false;
  const pkt6 = document.getElementById('pkt1');
  const pkt4 = document.getElementById('pkt2');
  const btn = document.getElementById('btnSend');
  const toggle = document.getElementById('btnToggle');
  const status = document.getElementById('status');

  // helper to animate: move packet to server, then bounce back / show result
  function animatePacket(el, topPct, duration=1600){
    el.classList.add('moving');
    // compute translate based on diagram width
    const startX = el.offsetLeft;
    const diagram = document.getElementById('diagram');
    const serverEl = document.querySelector('.server');
    const targetX = serverEl.getBoundingClientRect().left - diagram.getBoundingClientRect().left - 40;
    el.style.transform = `translateX(${targetX - startX}px) translateY(-50%)`;
    // return to start after duration
    setTimeout(()=> {
      el.style.transform = `translateX(0px) translateY(-50%)`;
      el.classList.remove('moving');
    }, duration + 400);
  }

  // simulate network path decision & interception
  function sendExample(){
    // small visual reset
    pkt6.style.opacity = '1';
    pkt4.style.opacity = '1';

    if(!forceIPv4){
      // JVM prefers dual-stack: packet 6 goes first (simulates being used)
      animatePacket(pkt6, 58);
      // simulate interception: show red flash on server and fade packet
      setTimeout(()=> {
        // "intercepted" behavior
        pkt6.style.opacity = '0.18';
        showAlert('请求通过 dual-stack/IPv6 路径被拦截（模拟） — 在 IDEA 中常见。', true);
      }, 1000);
      // the v4 packet still goes through (other tools or when forced IPv4, works)
      setTimeout(()=> animatePacket(pkt4, 34), 1200);
      setTimeout(()=> showAlert('直接通过 IPv4 的请求（如 Postman/curl 或 强制 IPv4）通常能成功。', false), 2600);
    } else {
      // forced IPv4: only the v4 packet is used and succeeds
      animatePacket(pkt4, 34);
      setTimeout(()=> showAlert('JVM 已强制 IPv4，Feign 请求通过 IPv4 通道成功。', false), 1800);
    }
  }

  function showAlert(msg, isErr){
    const existing = document.querySelector('.tempmsg');
    if(existing) existing.remove();
    const el = document.createElement('div');
    el.className = 'tempmsg';
    el.style.position = 'fixed';
    el.style.left = '50%';
    el.style.top = '12px';
    el.style.transform = 'translateX(-50%)';
    el.style.padding = '10px 16px';
    el.style.borderRadius = '10px';
    el.style.background = isErr ? 'linear-gradient(90deg, rgba(255,90,90,0.98), rgba(255,120,120,0.98))' : 'linear-gradient(90deg, rgba(80,160,255,0.98), rgba(120,190,255,0.98))';
    el.style.color = '#021028';
    el.style.fontWeight = 700;
    el.innerText = msg;
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 2800);
  }

  btn.addEventListener('click', sendExample);

  toggle.addEventListener('click', ()=>{
    forceIPv4 = !forceIPv4;
    toggle.innerText = forceIPv4 ? '切换：强制 IPv4 ON' : '切换：强制 IPv4 OFF';
    toggle.style.background = forceIPv4 ? '#6be4a6' : '#ffb86b';
    status.innerText = forceIPv4 ? '当前：JVM 已强制仅使用 IPv4' : '当前：JVM 优先双栈（IPv6 可见）';
  });

  // initial small intro animation
  setTimeout(()=> {
    showAlert('点击「发送示例请求」查看动画演示 Feign 请求通过哪条通道。', false);
  }, 700);
</script>
</body>
</html>
